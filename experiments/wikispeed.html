<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wikipedia Speed Run</title>
    <style>
      :root {
        --bg-color: #f4f4f0;
        --accent: #2c3e50;
        --highlight: #e74c3c;
        --text: #2f3542;
        --border: 3px solid #2f3542;
        --shadow: 4px 4px 0px #2f3542;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Courier New", Courier, monospace;
        background: var(--bg-color);
        color: var(--text);
        line-height: 1.6;
        padding-bottom: 2rem;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
      }

      /* --- Header --- */
      header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
      }

      h1 {
        font-size: 2.5rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -1px;
        margin-bottom: 0.5rem;
      }

      /* --- Layout --- */
      .game-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
        align-items: start;
      }

      @media (max-width: 900px) {
        .game-layout {
          grid-template-columns: 1fr;
        }
      }

      /* --- Sidebar --- */
      .sidebar {
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        position: sticky;
        top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        z-index: 10;
      }

      .target-box {
        background: var(--highlight);
        color: white;
        padding: 1rem;
        border: var(--border);
        text-align: center;
      }

      .target-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: bold;
        opacity: 0.9;
      }

      .target-title {
        font-size: 1.2rem;
        font-weight: 900;
        line-height: 1.2;
        margin-top: 0.5rem;
        word-wrap: break-word;
      }

      .target-desc {
        font-size: 0.85rem;
        margin-top: 0.5rem;
        font-style: italic;
        opacity: 0.9;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .stat-item {
        text-align: center;
        background: #eee;
        padding: 0.5rem;
        border: 2px solid #ddd;
      }
      .stat-val {
        font-size: 1.8rem;
        font-weight: 900;
      }
      .stat-lbl {
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: bold;
        color: #777;
      }

      /* --- Game Board --- */
      .game-board {
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
        min-height: 80vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .breadcrumbs {
        padding: 1rem;
        background: #eee;
        border-bottom: var(--border);
        font-size: 0.85rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }

      .crumb {
        color: #666;
      }
      .crumb:last-child {
        color: var(--highlight);
        font-weight: bold;
      }
      .crumb::after {
        content: "→";
        margin-left: 0.5rem;
        color: #ccc;
      }
      .crumb:last-child::after {
        display: none;
      }

      /* --- Wiki Content Styling --- */
      .wiki-content {
        padding: 2rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        font-size: 1.1rem;
        overflow-x: hidden;
        position: relative;
      }

      .wiki-content.loading {
        opacity: 0.5;
        pointer-events: none;
        user-select: none;
      }

      /* Loading Overlay */
      .loader-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        backdrop-filter: blur(2px);
      }
      .loader-text {
        font-family: "Courier New", monospace;
        font-weight: 900;
        font-size: 2rem;
        color: var(--highlight);
        background: white;
        padding: 1rem 2rem;
        border: var(--border);
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
        animation: pulse 0.8s infinite alternate;
      }
      @keyframes pulse {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.05);
        }
      }

      /* Cleanup Wiki garbage */
      .wiki-content .mw-empty-elt,
      .wiki-content .infobox,
      .wiki-content .sidebar,
      .wiki-content .thumb,
      .wiki-content .reference,
      .wiki-content .hatnote,
      .wiki-content .ambox,
      .wiki-content .reflist,
      .wiki-content table,
      .wiki-content .mw-editsection {
        display: none !important;
      }

      .wiki-content h1 {
        font-size: 2.2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
      }
      .wiki-content h2 {
        font-size: 1.8rem;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #eee;
      }
      .wiki-content p {
        margin-bottom: 1rem;
        line-height: 1.6;
      }
      .wiki-content ul {
        padding-left: 2rem;
        margin-bottom: 1rem;
      }

      /* Links */
      .wiki-content a {
        color: #2980b9;
        text-decoration: none;
        font-weight: 500;
        cursor: pointer;
        padding: 0 2px;
        border-radius: 2px;
        transition: background 0.1s;
      }
      .wiki-content a:hover {
        text-decoration: underline;
        background: #e8f4fc;
        color: #1a5276;
      }
      /* Dead links */
      .wiki-content a.disabled-link {
        color: #bbb;
        pointer-events: none;
        cursor: default;
        text-decoration: none;
      }

      /* --- Buttons --- */
      button {
        background: var(--text);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-family: inherit;
        font-weight: 900;
        font-size: 1rem;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s;
        text-transform: uppercase;
      }
      button:hover {
        background: white;
        color: var(--text);
        border: var(--border);
        transform: translate(-2px, -2px);
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
      }
      button.secondary {
        background: #ddd;
        color: var(--text);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* --- Leaderboard --- */
      .leaderboard-section {
        margin-top: 2rem;
        border-top: 2px solid #eee;
        padding-top: 2rem;
      }
      .lb-tabs {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
      }
      .lb-tab {
        padding: 0.5rem 1rem;
        background: #eee;
        border: 2px solid #ddd;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
      }
      .lb-tab.active {
        background: var(--highlight);
        color: white;
        border-color: var(--highlight);
      }
      .lb-row {
        display: flex;
        justify-content: space-between;
        padding: 0.8rem;
        border-bottom: 1px solid #eee;
        font-family: -apple-system, sans-serif;
        font-size: 0.95rem;
      }
      .lb-row:nth-child(odd) {
        background: #fafafa;
      }
      .lb-rank {
        font-weight: bold;
        width: 30px;
        color: #888;
      }
      .lb-name {
        font-weight: 600;
        flex-grow: 1;
        text-align: left;
      }
      .lb-stat {
        font-family: "Courier New", monospace;
        color: var(--text);
      }

      /* --- Modal --- */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal {
        background: white;
        padding: 3rem;
        max-width: 600px;
        width: 90%;
        border: var(--border);
        box-shadow: 10px 10px 0px rgba(255, 255, 255, 0.2);
        text-align: center;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header id="menuScreen">
        <h1>Wiki Speed Run</h1>
        <p style="margin-bottom: 2rem; color: #666">
          Navigate from A to B using only internal links. <br />
          <small>Timer pauses while pages load.</small>
        </p>

        <div class="controls">
          <button id="startBtn">Start Game</button>
        </div>

        <div class="leaderboard-section">
          <h3>Your Personal Bests (Local)</h3>
          <div
            id="localStats"
            style="
              margin-top: 1rem;
              font-style: italic;
              color: #888;
              font-size: 0.9rem;
            "
          >
            No games played yet.
          </div>
        </div>

        <div class="leaderboard-section">
          <h3>Global Leaderboard</h3>
          <div class="lb-tabs">
            <div class="lb-tab active" data-sort="clicks">By Clicks</div>
            <div class="lb-tab" data-sort="time">By Time</div>
          </div>
          <div
            id="leaderboardList"
            style="margin-top: 1rem; max-height: 400px; overflow-y: auto"
          >
            Loading...
          </div>
        </div>
      </header>

      <div id="gameScreen" class="game-layout hidden">
        <aside class="sidebar">
          <div class="target-box">
            <div class="target-label">Target Page</div>
            <div class="target-title" id="targetDisplay">?</div>
            <div class="target-desc" id="targetDesc">...</div>
          </div>

          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-val" id="clickCount">0</div>
              <div class="stat-lbl">Clicks</div>
            </div>
            <div class="stat-item">
              <div class="stat-val" id="timerDisplay">0:00</div>
              <div class="stat-lbl">Time</div>
            </div>
          </div>

          <button class="secondary" id="giveUpBtn">Give Up</button>
        </aside>

        <main class="game-board">
          <div class="breadcrumbs" id="breadcrumbs"></div>
          <div id="wikiLoader" class="loader-overlay hidden">
            <div class="loader-text">TRAVELING...</div>
          </div>
          <div class="wiki-content" id="wikiContent"></div>
        </main>
      </div>
    </div>

    <div class="modal-overlay" id="winModal">
      <div class="modal">
        <h2
          style="color: var(--highlight); font-size: 3rem; margin-bottom: 1rem"
        >
          VICTORY!
        </h2>
        <p>
          You reached <strong><span id="winTargetName"></span></strong>
        </p>

        <div class="stats-grid" style="margin: 2rem 0">
          <div class="stat-item">
            <div class="stat-val" id="winClicks">0</div>
            <div class="stat-lbl">Clicks</div>
          </div>
          <div class="stat-item">
            <div class="stat-val" id="winTime">0:00</div>
            <div class="stat-lbl">Time</div>
          </div>
        </div>

        <input
          type="text"
          id="playerName"
          placeholder="Enter Name for Leaderboard"
          style="
            padding: 1rem;
            border: var(--border);
            width: 100%;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            text-align: center;
          "
        />
        <button id="submitScoreBtn">Submit Score</button>
        <button class="secondary" id="playAgainBtn" style="margin-top: 0.5rem">
          Play Again
        </button>
      </div>
    </div>

    <script>
      // --- CONFIG ---
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxJLd1l2RWakcrO0Txnjo65Cp4Bqp2RKe84R7bAwESuTvDTeDrMxF4mNXveKBUc108G/exec";

      // --- DATA LISTS ---
      // 1000+ Elements categorized for variety
      const WIKI_DATA = {
        Animals: [
          "Platypus",
          "Narwhal",
          "Axolotl",
          "Cassowary",
          "Pangolin",
          "Capybara",
          "Okapi",
          "Numbat",
          "Quokka",
          "Kakapo",
          "Tardigrade",
          "Blue_whale",
          "Komodo_dragon",
          "Giant_squid",
          "Honey_badger",
          "Tasmanian_devil",
          "Aye-aye",
          "Dugong",
          "Manatee",
          "Tapir",
          "Fossa_(animal)",
          "Saiga_antelope",
          "Pink_fairy_armadillo",
          "Goblin_shark",
          "Blobfish",
          "Shoebill",
          "Star-nosed_mole",
          "Vampire_squid",
          "Leafy_seadragon",
          "Coelacanth",
          "Thylacine",
          "Dodo",
          "Passenger_pigeon",
          "Great_auk",
          "Mammoth",
          "Saber-toothed_cat",
          "Megatherium",
          "Moa",
          "Haast's_eagle",
          "Steller's_sea_cow",
          "Aardvark",
          "Albatross",
          "Anteater",
          "Armadillo",
          "Baboon",
          "Badger",
          "Barracuda",
          "Bat",
          "Beaver",
          "Bison",
          "Bonobo",
          "Buffalo",
          "Camel",
          "Chameleon",
          "Cheetah",
          "Chimpanzee",
          "Chinchilla",
          "Cobra",
          "Cougar",
          "Coyote",
          "Crab",
          "Crane_(bird)",
          "Crocodile",
          "Crow",
          "Deer",
          "Dingo",
          "Dolphin",
          "Donkey",
          "Dragonfly",
          "Duck",
        ],
        "Food & Culinary": [
          "Samosa",
          "Pierogi",
          "Empanada",
          "Beignet",
          "Churro",
          "Baklava",
          "Dim_sum",
          "Mochi",
          "Stroopwafel",
          "Cannoli",
          "Haggis",
          "Surströmming",
          "Durian",
          "Casu_martzu",
          "Lutefisk",
          "Vegemite",
          "Marmite",
          "Natto",
          "Century_egg",
          "Balut_(food)",
          "Kimchi",
          "Poutine",
          "Goulash",
          "Paella",
          "Fondue",
          "Sushi",
          "Pho",
          "Pad_thai",
          "Ramen",
          "Croissant",
          "Borscht",
          "Gazpacho",
          "Falafel",
          "Hummus",
          "Tofu",
          "Seitan",
          "Tempeh",
          "Kombucha",
          "Bubble_tea",
          "Mate_(drink)",
          "Baguette",
          "Pretzel",
          "Sauerkraut",
          "Wasabi",
          "Saffron",
          "Vanilla",
          "Chocolate",
          "Coffee",
          "Tea",
          "Wine",
          "Beer",
          "Whisky",
          "Vodka",
          "Tequila",
          "Rum",
          "Gin",
          "Absinthe",
          "Mead",
          "Sake",
          "Kefir",
          "Yogurt",
          "Cheese",
          "Butter",
          "Cream",
          "Ice_cream",
          "Gelato",
          "Sorbet",
          "Custard",
          "Pudding",
          "Cake",
        ],
        "Music & Instruments": [
          "Vuvuzela",
          "Kazoo",
          "Didgeridoo",
          "Theremin",
          "Hurdy-gurdy",
          "Ocarina",
          "Pennywhistle",
          "Concertina",
          "Melodica",
          "Mbira",
          "Sitar",
          "Koto",
          "Balalaika",
          "Mandolin",
          "Dulcimer",
          "Bouzouki",
          "Shamisen",
          "Erhu",
          "Gamelan",
          "Hang_(instrument)",
          "Bagpipes",
          "Banjo",
          "Accordion",
          "Harpsichord",
          "Synthesizer",
          "Drum_machine",
          "Turntablism",
          "Zither",
          "Lute",
          "Lyre",
          "Glass_harmonica",
          "Hydraulis",
          "Calliope_(music)",
          "Celesta",
          "Glockenspiel",
          "Marimba",
          "Xylophone",
          "Vibraphone",
          "Tubular_bells",
          "Jew's_harp",
          "Violin",
          "Cello",
          "Double_bass",
          "Guitar",
          "Bass_guitar",
          "Drum_kit",
          "Piano",
          "Organ_(music)",
          "Flute",
          "Clarinet",
          "Oboe",
          "Bassoon",
          "Saxophone",
          "Trumpet",
          "Trombone",
          "Tuba",
          "French_horn",
          "Harp",
          "Ukulele",
          "Harmonica",
        ],
        "Physics & Space": [
          "Heisenberg_uncertainty_principle",
          "Schrödinger's_cat",
          "Fermi_paradox",
          "String_theory",
          "Dark_matter",
          "Dark_energy",
          "Black_hole",
          "Event_horizon",
          "Singularity_(system_theory)",
          "Big_Bang",
          "General_relativity",
          "Special_relativity",
          "Standard_Model",
          "Higgs_boson",
          "Antimatter",
          "Neutrino",
          "Quark",
          "Photon",
          "Gluon",
          "Gravitational_wave",
          "Supernova",
          "Neutron_star",
          "Pulsar",
          "Quasar",
          "Magnetar",
          "White_dwarf",
          "Red_giant",
          "Brown_dwarf",
          "Exoplanet",
          "Nebula",
          "Galaxy",
          "Milky_Way",
          "Andromeda_Galaxy",
          "Solar_System",
          "Sun",
          "Mercury_(planet)",
          "Venus",
          "Earth",
          "Mars",
          "Jupiter",
          "Saturn",
          "Uranus",
          "Neptune",
          "Pluto",
          "Asteroid_belt",
          "Kuiper_belt",
          "Oort_cloud",
          "Comet",
          "Meteor",
          "Cosmic_ray",
        ],
        "Math & Logic": [
          "Gödel's_incompleteness_theorems",
          "P_versus_NP_problem",
          "Riemann_hypothesis",
          "Twin_prime_conjecture",
          "Collatz_conjecture",
          "Goldbach's_conjecture",
          "Traveling_salesman_problem",
          "Knapsack_problem",
          "Halting_problem",
          "Game_of_Life",
          "Chaos_theory",
          "Butterfly_effect",
          "Fractal",
          "Mandelbrot_set",
          "Julia_set",
          "Koch_snowflake",
          "Sierpiński_triangle",
          "Golden_ratio",
          "Fibonacci_sequence",
          "Pi",
          "Euler's_identity",
          "Calculus",
          "Algebra",
          "Geometry",
          "Topology",
          "Set_theory",
          "Number_theory",
          "Combinatorics",
          "Graph_theory",
          "Probability_theory",
          "Statistics",
          "Algorithm",
          "Cryptography",
          "Prime_number",
          "Infinity",
        ],
        "Philosophy & Paradoxes": [
          "Ship_of_Theseus",
          "Chinese_room",
          "Mary's_room",
          "Trolley_problem",
          "Omnipotence_paradox",
          "Zeno's_paradoxes",
          "Sorites_paradox",
          "Russell's_paradox",
          "Barber_paradox",
          "Liar_paradox",
          "Grandfather_paradox",
          "Bootstrap_paradox",
          "Monty_Hall_problem",
          "Birthday_problem",
          "Sleeping_Beauty_problem",
          "Prisoner's_dilemma",
          "Unexpected_hanging_paradox",
          "Hilbert's_paradox_of_the_Grand_Hotel",
          "Gabriel's_Horn",
          "Banach–Tarski_paradox",
          "Nihilism",
          "Existentialism",
          "Stoicism",
          "Utilitarianism",
          "Deontology",
          "Solipsism",
          "Epistemology",
          "Metaphysics",
          "Ontology",
          "Aesthetics",
          "Categorical_imperative",
          "Veil_of_ignorance",
          "Social_contract",
          "Tabula_rasa",
          "Cogito,_ergo_sum",
          "Übermensch",
          "Eternal_return",
          "Will_to_power",
          "Dasein",
          "Phenomenology",
        ],
        "Computer Science": [
          "Turing_completeness",
          "Lambda_calculus",
          "Church–Turing_thesis",
          "NP-completeness",
          "Byzantine_fault",
          "CAP_theorem",
          "Dining_philosophers_problem",
          "Moore's_law",
          "Unix_time",
          "Y2K_problem",
          "Algorithm",
          "Data_structure",
          "Binary_tree",
          "Hash_table",
          "Linked_list",
          "Stack_(abstract_data_type)",
          "Queue_(abstract_data_type)",
          "Graph_(abstract_data_type)",
          "Sorting_algorithm",
          "Search_algorithm",
          "Artificial_intelligence",
          "Machine_learning",
          "Neural_network",
          "Deep_learning",
          "Computer_vision",
          "Natural_language_processing",
          "Robotics",
          "Cybernetics",
          "Information_theory",
          "Big_data",
          "Operating_system",
          "Kernel_(operating_system)",
          "Linux",
          "Windows",
          "MacOS",
          "Android_(operating_system)",
          "IOS",
          "Virtual_machine",
          "Cloud_computing",
          "Internet_of_things",
        ],
        "Ancient History": [
          "Ancient_Egypt",
          "Mesopotamia",
          "Indus_Valley_Civilisation",
          "Maya_civilization",
          "Aztec_Empire",
          "Inca_Empire",
          "Roman_Empire",
          "Byzantine_Empire",
          "Ottoman_Empire",
          "Mongol_Empire",
          "Sumer",
          "Babylon",
          "Assyria",
          "Persian_Empire",
          "Ancient_Greece",
          "Sparta",
          "Athens",
          "Alexander_the_Great",
          "Julius_Caesar",
          "Cleopatra",
          "Pharaoh",
          "Pyramids_of_Giza",
          "Sphinx",
          "Hieroglyph",
          "Rosetta_Stone",
          "Cuneiform",
          "Ziggurat",
          "Code_of_Hammurabi",
          "Epic_of_Gilgamesh",
          "Trojan_War",
          "Gladiator",
          "Colosseum",
          "Pantheon,_Rome",
          "Acropolis_of_Athens",
          "Parthenon",
          "Oracle_of_Delphi",
          "Library_of_Alexandria",
          "Silk_Road",
          "Terracotta_Army",
          "Great_Wall_of_China",
        ],
        "Modern History": [
          "Renaissance",
          "Age_of_Enlightenment",
          "Industrial_Revolution",
          "French_Revolution",
          "American_Revolution",
          "Russian_Revolution",
          "Meiji_Restoration",
          "Victorian_era",
          "Cold_War",
          "Space_Race",
          "World_War_I",
          "World_War_II",
          "Vietnam_War",
          "Korean_War",
          "Gulf_War",
          "War_on_Terror",
          "Fall_of_the_Berlin_Wall",
          "Dissolution_of_the_Soviet_Union",
          "September_11_attacks",
          "Arab_Spring",
          "Black_Death",
          "Spanish_flu",
          "Great_Depression",
          "Holocaust",
          "Apartheid",
          "Civil_Rights_Movement",
          "Suffragette",
          "Abolitionism",
          "Feudalism",
          "Mercantilism",
          "Columbian_exchange",
          "Age_of_Discovery",
          "Scramble_for_Africa",
          "Manifest_destiny",
          "Gold_Rush",
          "Prohibition_in_the_United_States",
          "Watergate_scandal",
          "Chernobyl_disaster",
          "Titanic",
          "Hindenburg_disaster",
        ],
        Geography: [
          "Antarctica",
          "Amazon_rainforest",
          "Sahara",
          "Gobi_Desert",
          "Himalayas",
          "Andes",
          "Alps",
          "Rocky_Mountains",
          "Great_Barrier_Reef",
          "Galápagos_Islands",
          "Mariana_Trench",
          "Dead_Sea",
          "Lake_Baikal",
          "Caspian_Sea",
          "Victoria_Falls",
          "Angel_Falls",
          "Grand_Canyon",
          "Yellowstone_Caldera",
          "Mount_Everest",
          "Mount_Kilimanjaro",
          "Vatican_City",
          "Monaco",
          "Nauru",
          "Tuvalu",
          "San_Marino",
          "Liechtenstein",
          "Lesotho",
          "Eswatini",
          "Bhutan",
          "Nepal",
          "Machu_Picchu",
          "Petra",
          "Chichen_Itza",
          "Taj_Mahal",
          "Angkor_Wat",
          "Stonehenge",
          "Easter_Island",
          "Bermuda_Triangle",
          "Panama_Canal",
          "Suez_Canal",
        ],
        "Art Movements": [
          "Impressionism",
          "Post-Impressionism",
          "Surrealism",
          "Cubism",
          "Expressionism",
          "Abstract_art",
          "Pop_art",
          "Renaissance_art",
          "Baroque",
          "Rococo",
          "Neoclassicism",
          "Romanticism",
          "Realism_(arts)",
          "Art_Nouveau",
          "Art_Deco",
          "Bauhaus",
          "Minimalism",
          "Dada",
          "Futurism",
          "Fauvism",
          "Pointillism",
          "Symbolism_(arts)",
          "Pre-Raphaelite_Brotherhood",
          "Mannerism",
          "Gothic_art",
          "Byzantine_art",
          "Romanesque_art",
          "Islamic_art",
          "Ukiyo-e",
          "Calligraphy",
        ],
        "Famous Artworks": [
          "Mona_Lisa",
          "The_Starry_Night",
          "The_Scream",
          "Guernica_(Picasso)",
          "The_Persistence_of_Memory",
          "Girl_with_a_Pearl_Earring",
          "The_Birth_of_Venus",
          "The_Last_Supper",
          "David_(Michelangelo)",
          "The_Thinker",
          "Venus_de_Milo",
          "Winged_Victory_of_Samothrace",
          "The_Night_Watch",
          "Las_Meninas",
          "The_Kiss_(Klimt)",
          "American_Gothic",
          "Nighthawks_(painting)",
          "Campbell's_Soup_Cans",
          "Marilyn_Diptych",
          "Fountain_(Duchamp)",
          "The_Great_Wave_off_Kanagawa",
          "Terracotta_Army",
          "Bust_of_Nefertiti",
          "The_School_of_Athens",
          "Creation_of_Adam",
          "The_Garden_of_Earthly_Delights",
          "Liberty_Leading_the_People",
          "Wanderer_above_the_Sea_of_Fog",
          "The_Hay_Wain",
          "Whistler's_Mother",
        ],
        Sports: [
          "Zorbing",
          "Parkour",
          "Slacklining",
          "Bouldering",
          "Sandboarding",
          "Kitesurfing",
          "Orienteering",
          "Canyoning",
          "Spelunking",
          "Base_jumping",
          "Capoeira",
          "Sumo",
          "Kabaddi",
          "Sepak_takraw",
          "Petanque",
          "Curling",
          "Cricket",
          "Rugby_union",
          "Lacrosse",
          "Hurling",
          "Football",
          "Basketball",
          "Baseball",
          "Tennis",
          "Golf",
          "Volleyball",
          "Ice_hockey",
          "Table_tennis",
          "Badminton",
          "Swimming",
          "Athletics",
          "Gymnastics",
          "Boxing",
          "Judo",
          "Karate",
          "Taekwondo",
          "Wrestling",
          "Fencing",
          "Archery",
          "Shooting_sports",
        ],
        "Games & Hobbies": [
          "Chess",
          "Go_(game)",
          "Shogi",
          "Xiangqi",
          "Backgammon",
          "Mahjong",
          "Poker",
          "Bridge_(card_game)",
          "Scrabble",
          "Sudoku",
          "Geocaching",
          "Philately",
          "Numismatics",
          "Deltiology",
          "Lepidoptery",
          "Herpetoculture",
          "Amateur_radio",
          "Train_spotting",
          "Birdwatching",
          "Gardening",
          "Knitting",
          "Crochet",
          "Sewing",
          "Quilting",
          "Embroidery",
          "Cross-stitch",
          "Pottery",
          "Woodworking",
          "Metalworking",
          "Glassblowing",
          "Dungeons_&_Dragons",
          "Magic:_The_Gathering",
          "Monopoly_(game)",
          "Risk_(game)",
          "Settlers_of_Catan",
          "Warhammer_40,000",
          "Cosplay",
          "LARP",
          "Speedcubing",
          "Yo-yo",
        ],
        Technology: [
          "Steam_engine",
          "Internal_combustion_engine",
          "Jet_engine",
          "Rocket_engine",
          "Nuclear_reactor",
          "Solar_panel",
          "Wind_turbine",
          "Hydroelectricity",
          "Geothermal_energy",
          "Fusion_power",
          "Transistor",
          "Integrated_circuit",
          "Microprocessor",
          "Vacuum_tube",
          "Fiber_optics",
          "Laser",
          "LED",
          "LCD",
          "OLED",
          "E-ink",
          "Internet",
          "World_Wide_Web",
          "Blockchain",
          "Cryptocurrency",
          "Bitcoin",
          "Ethereum",
          "NFT",
          "Virtual_reality",
          "Augmented_reality",
          "Metaverse",
          "Space_Station",
          "Satellite",
          "Rover_(space_exploration)",
          "Space_Shuttle",
          "Hubble_Space_Telescope",
          "James_Webb_Space_Telescope",
          "Large_Hadron_Collider",
          "Particle_accelerator",
          "Electron_microscope",
          "Scanning_tunneling_microscope",
          "Smartphone",
          "Laptop",
          "Tablet_computer",
          "Smartwatch",
          "Drone",
          "3D_printing",
          "Biometrics",
          "Facial_recognition_system",
          "Autonomous_car",
          "Electric_vehicle",
        ],
        Literature: [
          "Gilgamesh",
          "Odyssey",
          "Iliad",
          "Beowulf",
          "Divine_Comedy",
          "Paradise_Lost",
          "Don_Quixote",
          "Hamlet",
          "Macbeth",
          "Romeo_and_Juliet",
          "Frankenstein",
          "Dracula",
          "Moby-Dick",
          "Great_Gatsby",
          "1984_(novel)",
          "Brave_New_World",
          "Fahrenheit_451",
          "Lord_of_the_Rings",
          "Harry_Potter",
          "Game_of_Thrones",
          "Pride_and_Prejudice",
          "Jane_Eyre",
          "Wuthering_Heights",
          "Great_Expectations",
          "Oliver_Twist",
          "Les_Misérables",
          "The_Count_of_Monte_Cristo",
          "War_and_Peace",
          "Anna_Karenina",
          "Crime_and_Punishment",
          "The_Catcher_in_the_Rye",
          "To_Kill_a_Mockingbird",
          "The_Grapes_of_Wrath",
          "Of_Mice_and_Men",
          "The_Old_Man_and_the_Sea",
          "One_Hundred_Years_of_Solitude",
          "Don_Juan",
          "Faust",
          "The_Metamorphosis",
          "Ulysses_(novel)",
        ],
        "Mythology & Religion": [
          "Zeus",
          "Odin",
          "Ra",
          "Jupiter_(mythology)",
          "Vishnu",
          "Shiva",
          "Buddha",
          "Confucius",
          "Laozi",
          "Zoroaster",
          "Thor",
          "Loki",
          "Apollo",
          "Athena",
          "Poseidon",
          "Hades",
          "Aphrodite",
          "Ares",
          "Hermes",
          "Dionysus",
          "Anubis",
          "Osiris",
          "Isis",
          "Horus",
          "Set_(deity)",
          "Amaterasu",
          "Susanoo",
          "Tsukuyomi",
          "Izanagi",
          "Izanami",
          "Dragon",
          "Unicorn",
          "Phoenix_(mythology)",
          "Griffin",
          "Centaur",
          "Minotaur",
          "Hydra_(mythology)",
          "Chimera_(mythology)",
          "Kraken",
          "Leviathan",
          "Christianity",
          "Islam",
          "Judaism",
          "Hinduism",
          "Buddhism",
          "Sikhism",
          "Jainism",
          "Shinto",
          "Taoism",
          "Baháʼí_Faith",
        ],
        Chemistry: [
          "Periodic_table",
          "Atom",
          "Molecule",
          "Chemical_bond",
          "Covalent_bond",
          "Ionic_bonding",
          "Hydrogen_bond",
          "Van_der_Waals_force",
          "Chemical_reaction",
          "Catalysis",
          "Acid",
          "Base_(chemistry)",
          "PH",
          "Buffer_solution",
          "Titration",
          "Oxidation",
          "Reduction",
          "Electrolysis",
          "Stoichiometry",
          "Thermodynamics",
          "Organic_chemistry",
          "Inorganic_chemistry",
          "Biochemistry",
          "Polymer",
          "Plastic",
          "Nylon",
          "Polyester",
          "Teflon",
          "Kevlar",
          "Graphene",
          "Gold",
          "Silver",
          "Copper",
          "Iron",
          "Steel",
          "Aluminum",
          "Titanium",
          "Carbon",
          "Oxygen",
          "Nitrogen",
        ],
        "Biology & Medicine": [
          "Evolution",
          "Natural_selection",
          "Genetic_drift",
          "DNA",
          "RNA",
          "CRISPR",
          "Gene_editing",
          "Cloning",
          "Stem_cell",
          "Photosynthesis",
          "Cell_(biology)",
          "Mitosis",
          "Meiosis",
          "Protein",
          "Enzyme",
          "Hormone",
          "Vitamin",
          "Antibiotic",
          "Vaccine",
          "Immune_system",
          "Virus",
          "Bacteria",
          "Fungus",
          "Parasite",
          "Cancer",
          "Diabetes",
          "Malaria",
          "Tuberculosis",
          "HIV/AIDS",
          "COVID-19",
          "Brain",
          "Heart",
          "Lung",
          "Liver",
          "Kidney",
          "Stomach",
          "Intestine",
          "Skeleton",
          "Muscle",
          "Nervous_system",
        ],
        "Cinema & Film": [
          "Citizen_Kane",
          "The_Godfather",
          "Casablanca_(film)",
          "Gone_with_the_Wind_(film)",
          "Lawrence_of_Arabia_(film)",
          "The_Wizard_of_Oz_(1939_film)",
          "Schindler's_List",
          "Psycho_(1960_film)",
          "Star_Wars",
          "2001:_A_Space_Odyssey",
          "Pulp_Fiction",
          "Fight_Club",
          "The_Matrix",
          "Inception",
          "Interstellar",
          "The_Dark_Knight",
          "Forrest_Gump",
          "Titanic_(1997_film)",
          "Avatar_(2009_film)",
          "Avengers:_Endgame",
          "Silent_film",
          "Technicolor",
          "CGI",
          "Stop_motion",
          "Animation",
          "Anime",
          "Documentary_film",
          "Film_noir",
          "Spaghetti_Western",
          "Musical_film",
          "Oscar",
          "Cannes_Film_Festival",
          "Sundance_Film_Festival",
          "Golden_Globe_Award",
          "BAFTA",
          "Director",
          "Screenwriter",
          "Cinematography",
          "Film_editing",
          "Special_effects",
        ],
        Plants: [
          "Rose",
          "Tulip",
          "Orchid",
          "Sunflower",
          "Daisy",
          "Lily",
          "Lotus_(plant)",
          "Cactus",
          "Bamboo",
          "Fern",
          "Moss",
          "Algae",
          "Lichen",
          "Mushroom",
          "Truffle",
          "Oak",
          "Maple",
          "Pine",
          "Redwood",
          "Baobab",
          "Venus_flytrap",
          "Pitcher_plant",
          "Sundew",
          "Rafflesia",
          "Corpse_flower",
          "Wheat",
          "Rice",
          "Corn",
          "Potato",
          "Tomato",
          "Apple",
          "Banana",
          "Grape",
          "Orange_(fruit)",
          "Lemon",
          "Strawberry",
          "Blueberry",
          "Raspberry",
          "Watermelon",
          "Pineapple",
        ],
        "Minerals & Gems": [
          "Diamond",
          "Ruby",
          "Sapphire",
          "Emerald",
          "Amethyst",
          "Topaz",
          "Opal",
          "Pearl",
          "Jade",
          "Turquoise",
          "Quartz",
          "Feldspar",
          "Mica",
          "Calcite",
          "Gypsum",
          "Talc",
          "Sulfur",
          "Pyrite",
          "Hematite",
          "Magnetite",
          "Granite",
          "Basalt",
          "Limestone",
          "Sandstone",
          "Marble",
          "Slate",
          "Obsidian",
          "Pumice",
          "Coal",
          "Amber",
        ],
        Architecture: [
          "Gothic_architecture",
          "Baroque_architecture",
          "Neoclassical_architecture",
          "Art_Deco",
          "Bauhaus",
          "Brutalism",
          "Modern_architecture",
          "Postmodern_architecture",
          "Deconstructivism",
          "Sustainable_architecture",
          "Arch",
          "Dome",
          "Vault_(architecture)",
          "Flying_buttress",
          "Column",
          "Capital_(architecture)",
          "Frieze",
          "Pediment",
          "Spire",
          "Minaret",
          "Skyscraper",
          "Bridge",
          "Tunnel",
          "Dam",
          "Aqueduct",
          "Canal",
          "Fortification",
          "Castle",
          "Palace",
          "Cathedral",
        ],
        "Cryptids & Folklore": [
          "Bigfoot",
          "Loch_Ness_Monster",
          "Yeti",
          "Chupacabra",
          "Jersey_Devil",
          "Mothman",
          "Jackalope",
          "Wendigo",
          "Skin-walker",
          "Thunderbird_(mythology)",
          "Bunyip",
          "Yowie",
          "Mongolian_death_worm",
          "Dobhar-chú",
          "Kelpie",
          "Selkie",
          "Banshee",
          "Leprechaun",
          "Troll",
          "Goblin",
          "Vampire",
          "Werewolf",
          "Zombie",
          "Ghost",
          "Poltergeist",
          "Demon",
          "Angel",
          "Fairy",
          "Elf",
          "Gnome",
        ],
        "Language & Linguistics": [
          "Linguistics",
          "Phonology",
          "Morphology_(linguistics)",
          "Syntax",
          "Semantics",
          "Pragmatics",
          "Sociolinguistics",
          "Psycholinguistics",
          "Neurolinguistics",
          "Historical_linguistics",
          "Indo-European_languages",
          "Sino-Tibetan_languages",
          "Afroasiatic_languages",
          "Austronesian_languages",
          "Niger–Congo_languages",
          "Dravidian_languages",
          "Turkic_languages",
          "Japonic_languages",
          "Koreanic_languages",
          "Uralic_languages",
          "English_language",
          "Spanish_language",
          "Mandarin_Chinese",
          "Hindi",
          "Arabic",
          "Portuguese_language",
          "Bengali_language",
          "Russian_language",
          "Japanese_language",
          "Punjabi_language",
          "Alphabet",
          "Abjad",
          "Abugida",
          "Syllabary",
          "Logogram",
          "Hieroglyph",
          "Cuneiform",
          "Braille",
          "Morse_code",
          "Sign_language",
        ],
      };

      // --- STATE MANAGEMENT ---
      let gameState = {
        active: false,
        isLoading: false,
        startPage: "",
        targetPage: "",
        currentPage: "",
        clicks: 0,
        startTime: 0,
        totalPausedTime: 0,
        pauseStart: 0,
        path: [],
        timerInterval: null,
      };

      // Cache leaderboard
      let globalScoresCache = [];
      let currentLeaderboardSort = "clicks";

      // --- DOM ELEMENTS ---
      const els = {
        menu: document.getElementById("menuScreen"),
        game: document.getElementById("gameScreen"),
        content: document.getElementById("wikiContent"),
        loader: document.getElementById("wikiLoader"),
        breadcrumbs: document.getElementById("breadcrumbs"),
        targetDisplay: document.getElementById("targetDisplay"),
        targetDesc: document.getElementById("targetDesc"),
        clicks: document.getElementById("clickCount"),
        timer: document.getElementById("timerDisplay"),
        winModal: document.getElementById("winModal"),
        startBtn: document.getElementById("startBtn"),
        leaderboardList: document.getElementById("leaderboardList"),
      };

      // --- UTILS ---
      const formatTime = (seconds) => {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      };

      const normalizeTitle = (t) => t.replace(/_/g, " ").trim();

      // --- LEADERBOARD LOGIC ---
      async function fetchGlobalLeaderboard() {
        try {
          // Fetch once
          const res = await fetch(`${APPS_SCRIPT_URL}?action=getScores`);
          const data = await res.json();

          if (data.records) {
            globalScoresCache = data.records.filter(
              (s) =>
                s && typeof s.clicks === "number" && typeof s.time === "number"
            );
          }
          renderLeaderboard();
        } catch (e) {
          console.error("Leaderboard fetch failed", e);
          els.leaderboardList.innerHTML =
            "<small>Could not load leaderboard.</small>";
        }
      }

      function renderLeaderboard() {
        if (!globalScoresCache.length) {
          els.leaderboardList.innerHTML = "<small>No scores yet.</small>";
          return;
        }

        // Sort locally - Smooth switching
        const sorted = [...globalScoresCache].sort((a, b) => {
          if (currentLeaderboardSort === "clicks") {
            if (a.clicks !== b.clicks) return a.clicks - b.clicks;
            return a.time - b.time;
          } else {
            if (a.time !== b.time) return a.time - b.time;
            return a.clicks - b.clicks;
          }
        });

        const top10 = sorted.slice(0, 10);

        els.leaderboardList.innerHTML = top10
          .map(
            (s, i) => `
          <div class="lb-row">
            <span class="lb-rank">#${i + 1}</span>
            <span class="lb-name">${s.playerName || "Anonymous"}</span>
            <span class="lb-stat">${s.clicks} clicks • ${formatTime(
              s.time
            )}</span>
          </div>
        `
          )
          .join("");
      }

      // --- GAMEPLAY LOGIC ---
      async function startGame() {
        // 1. Get all available categories
        const categories = Object.keys(WIKI_DATA);

        // 2. Select a Random Start Category and Page
        const startCategory =
          categories[Math.floor(Math.random() * categories.length)];
        const startOptions = WIKI_DATA[startCategory];
        const startPage =
          startOptions[Math.floor(Math.random() * startOptions.length)];

        // 3. Select a Random Target Category (Must be different from start)
        let targetCategory = startCategory;
        while (targetCategory === startCategory) {
          targetCategory =
            categories[Math.floor(Math.random() * categories.length)];
        }
        const targetOptions = WIKI_DATA[targetCategory];
        const targetPage =
          targetOptions[Math.floor(Math.random() * targetOptions.length)];

        gameState = {
          active: true,
          isLoading: false,
          startPage: startPage,
          targetPage: targetPage,
          currentPage: "",
          clicks: 0,
          startTime: Date.now(),
          totalPausedTime: 0,
          pauseStart: 0,
          path: [],
          timerInterval: null,
        };

        // UI Reset
        els.menu.classList.add("hidden");
        els.game.classList.remove("hidden");
        els.winModal.style.display = "none";
        els.clicks.textContent = "0";
        els.timer.textContent = "0:00";
        els.content.innerHTML = "";

        // Setup Target
        els.targetDisplay.textContent = normalizeTitle(gameState.targetPage);
        els.targetDesc.textContent = `[${targetCategory}] Loading info...`;

        // Start Timer Loop
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        gameState.timerInterval = setInterval(updateTimer, 100);

        // Fetch Target Summary (background)
        fetch(
          `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(
            gameState.targetPage
          )}`
        )
          .then((r) => r.json())
          .then(
            (d) =>
              (els.targetDesc.textContent =
                `[${targetCategory}] ` +
                (d.description || d.extract || "Target Page"))
          )
          .catch(
            () =>
              (els.targetDesc.textContent = `[${targetCategory}] Wiki Article`)
          );

        // Load First Page
        await loadPage(gameState.startPage);
      }

      function updateTimer() {
        if (!gameState.active || gameState.isLoading) return;

        // Calculate effective time
        const currentDiff =
          Date.now() - gameState.startTime - gameState.totalPausedTime;
        const seconds = Math.floor(Math.max(0, currentDiff) / 1000); // Ensure no negatives
        els.timer.textContent = formatTime(seconds);
      }

      async function loadPage(title) {
        // PAUSE TIMER START
        gameState.isLoading = true;
        gameState.pauseStart = Date.now();
        els.loader.classList.remove("hidden");
        els.content.classList.add("loading");

        try {
          const endpoint = `https://en.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(
            title
          )}&prop=text&format=json&origin=*&redirects=1&disabletoc=1`;

          const response = await fetch(endpoint);
          const data = await response.json();

          if (data.error) throw new Error("Page not found");

          const html = data.parse.text["*"];
          const realTitle = data.parse.title;

          // Update State
          gameState.currentPage = realTitle;
          gameState.path.push(realTitle);

          // Render
          els.content.innerHTML = html;
          updateBreadcrumbs();
          window.scrollTo(0, 0);

          // Check Win Condition
          const cleanCurrent = normalizeTitle(realTitle).toLowerCase();
          const cleanTarget = normalizeTitle(
            gameState.targetPage
          ).toLowerCase();

          if (cleanCurrent === cleanTarget) {
            handleWin();
            // Don't unpause if win
            return;
          }
        } catch (e) {
          console.error(e);
          alert("Error loading page. Try clicking again.");
        } finally {
          // PAUSE TIMER END
          if (gameState.active) {
            const pauseDuration = Date.now() - gameState.pauseStart;
            gameState.totalPausedTime += pauseDuration;

            gameState.isLoading = false;
            els.loader.classList.add("hidden");
            els.content.classList.remove("loading");
          }
        }
      }

      // Event Delegation for clicks
      els.content.addEventListener("click", (e) => {
        if (!gameState.active || gameState.isLoading) return;

        const link = e.target.closest("a");
        if (!link) return;

        e.preventDefault();

        const href = link.getAttribute("href");

        // Check internal link
        if (href && href.startsWith("/wiki/") && !href.includes(":")) {
          const nextTitle = decodeURIComponent(href.split("/wiki/")[1]);
          gameState.clicks++;
          els.clicks.textContent = gameState.clicks;
          loadPage(nextTitle);
        }
      });

      // Disable other links
      els.content.addEventListener("mouseover", (e) => {
        const link = e.target.closest("a");
        if (link) {
          const href = link.getAttribute("href");
          if (!href || !href.startsWith("/wiki/") || href.includes(":")) {
            link.classList.add("disabled-link");
          }
        }
      });

      function updateBreadcrumbs() {
        const displayPath =
          gameState.path.length > 4
            ? ["...", ...gameState.path.slice(-4)]
            : gameState.path;

        els.breadcrumbs.innerHTML = displayPath
          .map((t) => `<span class="crumb">${normalizeTitle(t)}</span>`)
          .join("");
      }

      function handleWin() {
        gameState.active = false;
        clearInterval(gameState.timerInterval);

        // Final calculation
        const rawSeconds = Math.floor(
          (Date.now() - gameState.startTime - gameState.totalPausedTime) / 1000
        );
        const finalSeconds = Math.max(0, rawSeconds);

        document.getElementById("winTargetName").textContent = normalizeTitle(
          gameState.targetPage
        );
        document.getElementById("winClicks").textContent = gameState.clicks;
        document.getElementById("winTime").textContent =
          formatTime(finalSeconds);

        els.winModal.style.display = "flex";

        // Save local history
        saveLocalScore(gameState.clicks, finalSeconds);
      }

      // --- DATA STORAGE & STATS (FIXED) ---
      function saveLocalScore(clicks, time) {
        // Validation before saving
        const validClicks = parseInt(clicks) || 0;
        const validTime = parseInt(time) || 0;

        const history = JSON.parse(
          localStorage.getItem("wikiSpeedRun_history") || "[]"
        );
        history.push({
          clicks: validClicks,
          time: validTime,
          route: `${gameState.startPage} -> ${gameState.targetPage}`,
          date: new Date().toLocaleDateString(),
        });
        localStorage.setItem("wikiSpeedRun_history", JSON.stringify(history));
        renderLocalStats();
      }

      function renderLocalStats() {
        const history = JSON.parse(
          localStorage.getItem("wikiSpeedRun_history") || "[]"
        );
        if (!history.length) return;

        // FIXED: Filter out NaN or corrupted data from previous versions
        const valid = history.filter(
          (h) =>
            typeof h.clicks === "number" &&
            !isNaN(h.clicks) &&
            typeof h.time === "number" &&
            !isNaN(h.time) &&
            h.clicks > 0
        );

        if (!valid.length) {
          document.getElementById("localStats").innerHTML =
            "No valid games played yet.";
          return;
        }

        const bestClick = [...valid].sort((a, b) => a.clicks - b.clicks)[0];
        const bestTime = [...valid].sort((a, b) => a.time - b.time)[0];

        document.getElementById("localStats").innerHTML = `
          <strong>Best Clicks:</strong> ${bestClick.clicks} (${formatTime(
          bestClick.time
        )})<br>
          <strong>Best Time:</strong> ${formatTime(bestTime.time)} (${
          bestTime.clicks
        } clicks)
        `;
      }

      // --- EVENT LISTENERS ---
      els.startBtn.addEventListener("click", startGame);

      document.getElementById("giveUpBtn").addEventListener("click", () => {
        if (confirm("Give up?")) location.reload();
      });

      document
        .getElementById("playAgainBtn")
        .addEventListener("click", () => location.reload());

      document
        .getElementById("submitScoreBtn")
        .addEventListener("click", async function () {
          const name = document.getElementById("playerName").value.trim();
          if (!name) return alert("Please enter a name");

          this.textContent = "Sending...";
          this.disabled = true;

          const finalSeconds = Math.max(
            0,
            Math.floor(
              (Date.now() - gameState.startTime - gameState.totalPausedTime) /
                1000
            )
          );

          try {
            await fetch(APPS_SCRIPT_URL, {
              method: "POST",
              mode: "no-cors",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                playerName: name,
                clicks: gameState.clicks,
                time: finalSeconds,
                route: `${gameState.startPage} -> ${gameState.targetPage}`,
                timestamp: Date.now(),
              }),
            });

            this.textContent = "Saved!";
            setTimeout(() => {
              // Refresh leaderboard after submit
              fetchGlobalLeaderboard().then(() => {
                els.winModal.style.display = "none";
                els.menu.classList.remove("hidden");
                els.game.classList.add("hidden");
              });
            }, 1000);
          } catch (e) {
            alert("Error saving score (Network)");
            this.disabled = false;
          }
        });

      // Tab Switching
      document.querySelectorAll(".lb-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".lb-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentLeaderboardSort = tab.dataset.sort;
          renderLeaderboard();
        });
      });

      // --- ANTI-CHEAT (Ctrl+F Blocker) ---
      document.addEventListener("keydown", function (e) {
        // Block Ctrl+F, Cmd+F, Ctrl+G, Cmd+G (Find/Next)
        if (
          (e.ctrlKey || e.metaKey) &&
          (e.key === "f" || e.key === "g" || e.key === "F")
        ) {
          e.preventDefault();
        }
        // Block F3 (Find Next)
        if (e.key === "F3") {
          e.preventDefault();
        }
      });

      // Initialize
      renderLocalStats();
      fetchGlobalLeaderboard();
    </script>
  </body>
</html>
