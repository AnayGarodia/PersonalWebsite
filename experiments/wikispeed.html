<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wikipedia Speed Run</title>
    <style>
      :root {
        --bg-color: #f4f4f0;
        --accent: #ff4757;
        --text: #2f3542;
        --border: 3px solid #2f3542;
        --shadow: 4px 4px 0px #2f3542;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Courier New", Courier, monospace;
        background: var(--bg-color);
        color: var(--text);
        line-height: 1.6;
        padding-bottom: 2rem;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
      }

      header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
      }

      h1 {
        font-size: 2.5rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -1px;
        margin-bottom: 0.5rem;
      }

      .game-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
        align-items: start;
      }

      .sidebar {
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        position: sticky;
        top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .target-box {
        background: var(--accent);
        color: white;
        padding: 1rem;
        border: var(--border);
        text-align: center;
      }

      .target-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: bold;
        opacity: 0.9;
      }

      .target-title {
        font-size: 1.4rem;
        font-weight: 900;
        line-height: 1.2;
        margin-top: 0.5rem;
      }

      .target-desc {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        opacity: 0.9;
        font-style: italic;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .stat-item {
        text-align: center;
      }
      .stat-val {
        font-size: 2rem;
        font-weight: 900;
      }
      .stat-lbl {
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: bold;
        color: #777;
      }

      .game-board {
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
        min-height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .breadcrumbs {
        padding: 1rem;
        background: #eee;
        border-bottom: var(--border);
        font-size: 0.85rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }

      .crumb {
        color: #666;
      }
      .crumb:last-child {
        color: var(--accent);
        font-weight: bold;
      }
      .crumb::after {
        content: "→";
        margin-left: 0.5rem;
        color: #ccc;
      }
      .crumb:last-child::after {
        display: none;
      }

      .wiki-content {
        padding: 2rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        font-size: 1.1rem;
        overflow-x: hidden;
        transition: opacity 0.15s ease;
      }

      .wiki-content h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
      }
      .wiki-content h2 {
        font-size: 1.5rem;
        margin-top: 2rem;
        margin-bottom: 1rem;
        font-weight: bold;
        border-bottom: 1px solid #eee;
      }
      .wiki-content p {
        margin-bottom: 1rem;
      }
      .wiki-content ul {
        padding-left: 2rem;
        margin-bottom: 1rem;
      }
      .wiki-content a {
        color: #2980b9;
        text-decoration: none;
        font-weight: 500;
      }
      .wiki-content a:hover {
        text-decoration: underline;
        background: #e8f4fc;
      }
      .wiki-content .mw-empty-elt {
        display: none;
      }
      .wiki-content .infobox,
      .wiki-content .sidebar,
      .wiki-content .thumb,
      .wiki-content .reference,
      .wiki-content .hatnote,
      .wiki-content .ambox,
      .wiki-content .reflist,
      .wiki-content table {
        display: none !important;
      }

      button {
        background: var(--text);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-family: inherit;
        font-weight: 900;
        font-size: 1rem;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s;
        text-transform: uppercase;
      }
      button:hover {
        background: white;
        color: var(--text);
        border: var(--border);
        transform: translate(-2px, -2px);
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
      }
      button.secondary {
        background: #ddd;
        color: var(--text);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal {
        background: white;
        padding: 3rem;
        max-width: 600px;
        width: 90%;
        border: var(--border);
        box-shadow: 10px 10px 0px rgba(255, 255, 255, 0.2);
        text-align: center;
      }
      .modal h2 {
        color: var(--accent);
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      .leaderboard-section {
        margin-top: 2rem;
        border-top: 2px solid #eee;
        padding-top: 2rem;
      }

      .lb-tabs {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .lb-tab {
        padding: 0.5rem 1rem;
        background: #eee;
        border: 2px solid #ddd;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
      }

      .lb-tab.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .lb-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        font-family: -apple-system, sans-serif;
      }
      .lb-row.header {
        font-weight: bold;
        text-transform: uppercase;
        color: #888;
        font-size: 0.8rem;
      }

      .hidden {
        display: none !important;
      }
      .loading-spinner {
        font-size: 1.5rem;
        color: #888;
        text-align: center;
        padding: 3rem;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      @media (max-width: 900px) {
        .game-layout {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: static;
          margin-bottom: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header id="menuScreen">
        <h1>Wiki Speed Run</h1>
        <p style="margin-bottom: 2rem; color: #666">
          Navigate from A to B using only internal links.
        </p>

        <div class="controls">
          <button id="startBtn">Start Game</button>
        </div>

        <div class="leaderboard-section">
          <h3>Your Personal Bests (Local)</h3>
          <div
            id="localStats"
            style="margin-top: 1rem; font-style: italic; color: #888"
          >
            No games played yet.
          </div>
        </div>

        <div class="leaderboard-section">
          <h3>Global Leaderboard</h3>
          <div class="lb-tabs">
            <div class="lb-tab active" data-sort="clicks">By Clicks</div>
            <div class="lb-tab" data-sort="time">By Time</div>
          </div>
          <div id="leaderboardList" style="margin-top: 1rem">Loading...</div>
        </div>
      </header>

      <div id="gameScreen" class="game-layout hidden">
        <aside class="sidebar">
          <div class="target-box">
            <div class="target-label">Target Page</div>
            <div class="target-title" id="targetDisplay">?</div>
            <div class="target-desc" id="targetDesc">
              Loading description...
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-val" id="clickCount">0</div>
              <div class="stat-lbl">Clicks</div>
            </div>
            <div class="stat-item">
              <div class="stat-val" id="timerDisplay">0:00</div>
              <div class="stat-lbl">Time</div>
            </div>
          </div>

          <button class="secondary" id="giveUpBtn">Give Up</button>
        </aside>

        <main class="game-board">
          <div class="breadcrumbs" id="breadcrumbs"></div>
          <div class="wiki-content" id="wikiContent"></div>
        </main>
      </div>
    </div>

    <div class="modal-overlay" id="winModal">
      <div class="modal">
        <h2>VICTORY!</h2>
        <p>
          You reached <strong><span id="winTargetName"></span></strong>
        </p>

        <div class="stats-grid" style="margin: 2rem 0">
          <div class="stat-item">
            <div class="stat-val" id="winClicks">0</div>
            <div class="stat-lbl">Clicks</div>
          </div>
          <div class="stat-item">
            <div class="stat-val" id="winTime">0:00</div>
            <div class="stat-lbl">Time</div>
          </div>
        </div>

        <input
          type="text"
          id="playerName"
          placeholder="Enter Name for Leaderboard"
          style="
            padding: 1rem;
            border: var(--border);
            width: 100%;
            margin-bottom: 1rem;
            font-size: 1.1rem;
          "
        />
        <button id="submitScoreBtn">Submit Score</button>
        <button class="secondary" id="playAgainBtn" style="margin-top: 0.5rem">
          Play Again
        </button>
      </div>
    </div>

    <script>
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxJLd1l2RWakcrO0Txnjo65Cp4Bqp2RKe84R7bAwESuTvDTeDrMxF4mNXveKBUc108G/exec";

      // Extremely specific, obscure starting points - very few direct connections
      const startingPoints = [
        "Vuvuzela",
        "Kazoo",
        "Didgeridoo",
        "Theremin",
        "Hurdy-gurdy",
        "Ocarina",
        "Pennywhistle",
        "Concertina",
        "Melodica",
        "Mbira",
        "Quokka",
        "Axolotl",
        "Pangolin",
        "Okapi",
        "Narwhal",
        "Tapir",
        "Dugong",
        "Capybara",
        "Numbat",
        "Cassowary",
        "Samosa",
        "Pierogi",
        "Empanada",
        "Beignet",
        "Churro",
        "Baklava",
        "Dim_sum",
        "Mochi",
        "Stroopwafel",
        "Cannoli",
        "Zoetrope",
        "Astrolabe",
        "Sextant",
        "Orrery",
        "Pantograph",
        "Planisphere",
        "Chronometer",
        "Theodolite",
        "Anemometer",
        "Hygrometer",
        "Zorbing",
        "Parkour",
        "Slacklining",
        "Bouldering",
        "Geocaching",
        "Sandboarding",
        "Kitesurfing",
        "Orienteering",
        "Canyoning",
        "Spelunking",
        "Didgeridoo",
        "Sitar",
        "Koto",
        "Balalaika",
        "Mandolin",
        "Dulcimer",
        "Bouzouki",
        "Shamisen",
        "Erhu",
        "Gamelan",
        "Origami",
        "Macramé",
        "Decoupage",
        "Pyrography",
        "Marquetry",
        "Scrimshaw",
        "Batik",
        "Cloisonné",
        "Niello",
        "Intarsia",
        "Capoeira",
        "Kabuki",
        "Kathakali",
        "Butoh",
        "Taiko",
        "Flamenco",
        "Sumo",
        "Kabaddi",
        "Sepak_takraw",
        "Petanque",
      ];

      // Highly specific, technical, or niche target topics - require many hops
      const targetTopics = [
        "Heisenberg_uncertainty_principle",
        "Schrödinger's_cat",
        "Fermi_paradox",
        "Gödel's_incompleteness_theorems",
        "P_versus_NP_problem",
        "Riemann_hypothesis",
        "Navier–Stokes_existence_and_smoothness",
        "Twin_prime_conjecture",
        "Collatz_conjecture",
        "Goldbach's_conjecture",
        "Traveling_salesman_problem",
        "Banach–Tarski_paradox",
        "Arrow's_impossibility_theorem",
        "Prisoner's_dilemma",
        "Ship_of_Theseus",
        "Chinese_room",
        "Mary's_room",
        "Trolley_problem",
        "Omnipotence_paradox",
        "Zeno's_paradoxes",
        "Sorites_paradox",
        "Russell's_paradox",
        "Barber_paradox",
        "Liar_paradox",
        "Theseus's_paradox",
        "Grandfather_paradox",
        "Bootstrap_paradox",
        "Monty_Hall_problem",
        "Birthday_problem",
        "Sleeping_Beauty_problem",
        "Two_envelopes_problem",
        "Unexpected_hanging_paradox",
        "Hilbert's_paradox_of_the_Grand_Hotel",
        "Gabriel's_Horn",
        "Koch_snowflake",
        "Menger_sponge",
        "Sierpiński_triangle",
        "Barnsley_fern",
        "Mandelbrot_set",
        "Julia_set",
        "Lorenz_attractor",
        "Halting_problem",
        "Byzantine_fault",
        "CAP_theorem",
        "Turing_completeness",
        "Lambda_calculus",
        "Church–Turing_thesis",
        "NP-completeness",
        "Chomsky_hierarchy",
        "Rice's_theorem",
        "Curry–Howard_correspondence",
        "Y_combinator",
        "Qualia",
        "Philosophical_zombie",
        "Hard_problem_of_consciousness",
        "Cartesian_doubt",
        "Cogito,_ergo_sum",
        "Kantian_ethics",
        "Categorical_imperative",
        "Veil_of_ignorance",
        "Original_position",
        "Übermensch",
        "Eternal_return",
        "Will_to_power",
        "Dasein",
        "Being_and_Time",
        "Phenomenology",
        "Tabula_rasa",
        "Social_contract",
        "State_of_nature",
        "Panpsychism",
        "Neutral_monism",
        "Eliminative_materialism",
        "Mereological_nihilism",
        "Four-dimensionalism",
        "Endurantism",
      ];

      let gameState = {
        active: false,
        startPage: "",
        targetPage: "",
        currentPage: "",
        clicks: 0,
        startTime: 0,
        elapsedSeconds: 0,
        timerInterval: null,
        path: [],
      };

      let currentLeaderboardSort = "clicks";

      const els = {
        menu: document.getElementById("menuScreen"),
        game: document.getElementById("gameScreen"),
        content: document.getElementById("wikiContent"),
        breadcrumbs: document.getElementById("breadcrumbs"),
        targetDisplay: document.getElementById("targetDisplay"),
        targetDesc: document.getElementById("targetDesc"),
        clicks: document.getElementById("clickCount"),
        timer: document.getElementById("timerDisplay"),
        winModal: document.getElementById("winModal"),
        startBtn: document.getElementById("startBtn"),
        giveUpBtn: document.getElementById("giveUpBtn"),
        submitBtn: document.getElementById("submitScoreBtn"),
        playAgainBtn: document.getElementById("playAgainBtn"),
      };

      // Fetch with timeout to prevent infinite loading
      async function fetchWithTimeout(url, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);

        try {
          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
          });
          clearTimeout(id);
          return response;
        } catch (error) {
          clearTimeout(id);
          throw error;
        }
      }

      async function fetchWikiContent(title) {
        const endpoint = `https://en.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(
          title
        )}&prop=text&format=json&origin=*&redirects=1&disabletoc=1`;
        try {
          const response = await fetchWithTimeout(endpoint, {}, 8000);
          const data = await response.json();
          if (data.error) throw new Error(data.error.info);
          return {
            title: data.parse.title,
            html: data.parse.text["*"],
          };
        } catch (e) {
          console.error("Wiki Fetch Error", e);
          throw e;
        }
      }

      async function fetchWikiSummary(title) {
        const endpoint = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(
          title
        )}`;
        try {
          const response = await fetchWithTimeout(endpoint);
          return await response.json();
        } catch (e) {
          return { description: "Target Page" };
        }
      }

      async function startGame() {
        gameState.clicks = 0;
        gameState.elapsedSeconds = 0;
        gameState.path = [];
        gameState.active = true;

        gameState.startPage =
          startingPoints[Math.floor(Math.random() * startingPoints.length)];
        gameState.targetPage =
          targetTopics[Math.floor(Math.random() * targetTopics.length)];

        // Ensure start and target are different
        while (gameState.startPage === gameState.targetPage) {
          gameState.targetPage =
            targetTopics[Math.floor(Math.random() * targetTopics.length)];
        }

        els.menu.classList.add("hidden");
        els.game.classList.remove("hidden");
        els.winModal.style.display = "none";
        els.clicks.textContent = "0";
        els.timer.textContent = "0:00";

        els.targetDisplay.textContent = gameState.targetPage.replace(/_/g, " ");
        fetchWikiSummary(gameState.targetPage).then((data) => {
          els.targetDesc.textContent =
            data.description || data.extract || "A Wikipedia Article";
        });

        gameState.startTime = Date.now();
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        gameState.timerInterval = setInterval(() => {
          gameState.elapsedSeconds = Math.floor(
            (Date.now() - gameState.startTime) / 1000
          );
          updateTimer();
        }, 100);

        await loadPage(gameState.startPage);
      }

      async function loadPage(title) {
        // Instant visual feedback
        els.content.style.opacity = "0.3";

        try {
          const data = await fetchWikiContent(title);

          gameState.currentPage = data.title;
          gameState.path.push(data.title);

          // Update everything at once
          els.content.innerHTML = data.html;
          els.content.style.opacity = "1";
          updateBreadcrumbs();
          processLinks();
          window.scrollTo({ top: 0, behavior: "instant" });

          const cleanCurrent = data.title
            .toLowerCase()
            .replace(/_/g, " ")
            .trim();
          const cleanTarget = gameState.targetPage
            .toLowerCase()
            .replace(/_/g, " ")
            .trim();

          if (cleanCurrent === cleanTarget) {
            handleWin();
          }
        } catch (error) {
          els.content.style.opacity = "1";
          els.content.innerHTML = `<div style="padding: 2rem; text-align: center;">
            <p style="color: #e74c3c; margin-bottom: 1rem;">Failed to load page: ${error.message}</p>
            <button onclick="loadPage('${title}')">Try Again</button>
          </div>`;
        }
      }

      function processLinks() {
        const links = els.content.querySelectorAll("a");

        links.forEach((link) => {
          const href = link.getAttribute("href");

          if (href && href.startsWith("/wiki/") && !href.includes(":")) {
            link.style.cursor = "pointer";
            link.addEventListener(
              "click",
              (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!gameState.active) return;

                const nextTitle = decodeURIComponent(href.split("/wiki/")[1]);
                gameState.clicks++;
                els.clicks.textContent = gameState.clicks;
                loadPage(nextTitle);
              },
              { once: false, passive: false }
            );
          } else {
            link.removeAttribute("href");
            link.style.color = "#999";
            link.style.cursor = "default";
            link.style.textDecoration = "none";
            link.style.pointerEvents = "none";
          }
        });
      }

      function updateBreadcrumbs() {
        const showPath =
          gameState.path.length > 4
            ? ["...", ...gameState.path.slice(-4)]
            : gameState.path;

        els.breadcrumbs.innerHTML = showPath
          .map(
            (item) => `<span class="crumb">${item.replace(/_/g, " ")}</span>`
          )
          .join("");
      }

      function updateTimer() {
        const mins = Math.floor(gameState.elapsedSeconds / 60);
        const secs = gameState.elapsedSeconds % 60;
        els.timer.textContent = `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      function handleWin() {
        gameState.active = false;
        clearInterval(gameState.timerInterval);

        // Ensure we have a valid final time
        const finalTime = Math.floor((Date.now() - gameState.startTime) / 1000);
        gameState.elapsedSeconds = finalTime;

        const timeVal = `${Math.floor(finalTime / 60)}:${(finalTime % 60)
          .toString()
          .padStart(2, "0")}`;

        document.getElementById("winTargetName").textContent =
          gameState.targetPage.replace(/_/g, " ");
        document.getElementById("winClicks").textContent = gameState.clicks;
        document.getElementById("winTime").textContent = timeVal;

        els.winModal.style.display = "flex";

        saveLocalScore(gameState.clicks, finalTime);
      }

      function saveLocalScore(clicks, timeInSeconds) {
        const history = JSON.parse(
          localStorage.getItem("wikiSpeedRun_history") || "[]"
        );
        history.push({
          date: new Date().toLocaleDateString(),
          clicks: parseInt(clicks),
          time: parseInt(timeInSeconds),
          route: `${gameState.startPage.replace(
            /_/g,
            " "
          )} → ${gameState.targetPage.replace(/_/g, " ")}`,
        });
        localStorage.setItem("wikiSpeedRun_history", JSON.stringify(history));
        renderLocalStats();
      }

      function renderLocalStats() {
        const history = JSON.parse(
          localStorage.getItem("wikiSpeedRun_history") || "[]"
        );
        if (history.length === 0) return;

        // Filter valid entries and convert to numbers
        const validHistory = history
          .filter(
            (h) =>
              h &&
              typeof h.clicks !== "undefined" &&
              typeof h.time !== "undefined" &&
              !isNaN(parseInt(h.clicks)) &&
              !isNaN(parseInt(h.time))
          )
          .map((h) => ({
            ...h,
            clicks: parseInt(h.clicks),
            time: parseInt(h.time),
          }));

        if (validHistory.length === 0) return;

        const bestClicks = [...validHistory].sort(
          (a, b) => a.clicks - b.clicks
        )[0];
        const bestTime = [...validHistory].sort((a, b) => a.time - b.time)[0];

        const bestClicksTime = `${Math.floor(bestClicks.time / 60)}:${(
          bestClicks.time % 60
        )
          .toString()
          .padStart(2, "0")}`;
        const bestTimeClicks = bestTime.clicks;
        const bestTimeFormatted = `${Math.floor(bestTime.time / 60)}:${(
          bestTime.time % 60
        )
          .toString()
          .padStart(2, "0")}`;

        document.getElementById("localStats").innerHTML = `
          <div style="text-align: left; max-width: 400px; margin: 0 auto;">
            <strong>Best by Clicks:</strong> ${bestClicks.clicks} clicks in ${bestClicksTime}<br>
            <small>(${bestClicks.route})</small><br><br>
            <strong>Best by Time:</strong> ${bestTimeFormatted} in ${bestTimeClicks} clicks<br>
            <small>(${bestTime.route})</small>
          </div>
        `;
      }

      async function submitGlobalScore() {
        const name =
          document.getElementById("playerName").value.trim() || "Anonymous";
        const btn = document.getElementById("submitScoreBtn");

        const originalText = btn.textContent;
        btn.textContent = "Submitting...";
        btn.disabled = true;
        btn.style.opacity = "0.7";

        try {
          const payload = {
            playerName: name,
            clicks: parseInt(gameState.clicks),
            time: parseInt(gameState.elapsedSeconds),
            route: `${gameState.startPage.replace(
              /_/g,
              " "
            )} → ${gameState.targetPage.replace(/_/g, " ")}`,
            timestamp: Date.now(),
          };

          await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          btn.textContent = "Score Saved!";
          btn.style.backgroundColor = "#27ae60";
          btn.style.borderColor = "#27ae60";
          btn.style.opacity = "1";

          setTimeout(() => loadGlobalLeaderboard(), 1500);
        } catch (e) {
          console.error("Submit error:", e);
          btn.textContent = "Error (Saved Locally)";
          btn.style.backgroundColor = "#e74c3c";
        }
      }

      async function loadGlobalLeaderboard() {
        const list = document.getElementById("leaderboardList");
        if (
          APPS_SCRIPT_URL.includes("script.google.com") &&
          !APPS_SCRIPT_URL.includes("YOUR_URL")
        ) {
          try {
            const res = await fetchWithTimeout(
              `${APPS_SCRIPT_URL}?action=getScores`,
              {},
              5000
            );
            const data = await res.json();

            let scores = data.records || [];

            // Filter out invalid scores
            scores = scores.filter(
              (s) =>
                s &&
                typeof s.clicks === "number" &&
                typeof s.time === "number" &&
                !isNaN(s.clicks) &&
                !isNaN(s.time) &&
                s.clicks > 0 &&
                s.time > 0
            );

            if (currentLeaderboardSort === "clicks") {
              scores = scores.sort((a, b) => {
                if (a.clicks !== b.clicks) return a.clicks - b.clicks;
                return a.time - b.time;
              });
            } else {
              scores = scores.sort((a, b) => {
                if (a.time !== b.time) return a.time - b.time;
                return a.clicks - b.clicks;
              });
            }

            scores = scores.slice(0, 10);

            if (scores.length === 0) {
              list.innerHTML = "<small>No scores yet. Be the first!</small>";
            } else {
              list.innerHTML = scores
                .map(
                  (s, i) => `
                <div class="lb-row">
                  <span>#${i + 1} ${s.playerName || "Anonymous"}</span>
                  <span>${s.clicks} clicks • ${Math.floor(s.time / 60)}:${(
                    s.time % 60
                  )
                    .toString()
                    .padStart(2, "0")}</span>
                </div>
              `
                )
                .join("");
            }
          } catch (e) {
            console.error("Leaderboard error:", e);
            list.innerHTML = "<small>Leaderboard unavailable</small>";
          }
        } else {
          list.innerHTML = "<small>Leaderboard not configured.</small>";
        }
      }

      // Event Listeners
      els.startBtn.addEventListener("click", startGame);

      els.giveUpBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to quit?")) {
          location.reload();
        }
      });

      els.playAgainBtn.addEventListener("click", () => {
        location.reload();
      });

      els.submitBtn.addEventListener("click", submitGlobalScore);

      // Leaderboard tabs
      document.querySelectorAll(".lb-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".lb-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentLeaderboardSort = tab.dataset.sort;
          loadGlobalLeaderboard();
        });
      });

      // Disable Ctrl+F and Cmd+F during gameplay
      document.addEventListener(
        "keydown",
        function (e) {
          if (gameState.active && (e.ctrlKey || e.metaKey) && e.key === "f") {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        },
        true
      );

      // Disable right-click context menu during gameplay
      document.addEventListener("contextmenu", function (e) {
        if (gameState.active && e.target.closest(".wiki-content")) {
          e.preventDefault();
          return false;
        }
      });

      // Disable text selection in wiki content during gameplay
      els.content.addEventListener("mousedown", function (e) {
        if (gameState.active && !e.target.matches("a")) {
          e.preventDefault();
        }
      });

      // Initialize
      renderLocalStats();
      loadGlobalLeaderboard();
    </script>
  </body>
</html>
