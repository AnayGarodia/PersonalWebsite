<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wikipedia Speed Run</title>
    <style>
      :root {
        --bg-color: #f4f4f0;
        --accent: #ff4757;
        --text: #2f3542;
        --border: 3px solid #2f3542;
        --shadow: 4px 4px 0px #2f3542;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Courier New", Courier, monospace; /* Retro vibe */
        background: var(--bg-color);
        color: var(--text);
        line-height: 1.6;
        padding-bottom: 2rem;
      }

      /* --- Layout --- */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
      }

      header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
      }

      h1 {
        font-size: 2.5rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: -1px;
        margin-bottom: 0.5rem;
      }

      .game-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
        align-items: start;
      }

      /* --- Sidebar --- */
      .sidebar {
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        position: sticky;
        top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .target-box {
        background: var(--accent);
        color: white;
        padding: 1rem;
        border: var(--border);
        text-align: center;
      }

      .target-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: bold;
        opacity: 0.9;
      }

      .target-title {
        font-size: 1.4rem;
        font-weight: 900;
        line-height: 1.2;
        margin-top: 0.5rem;
      }

      .target-desc {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        opacity: 0.9;
        font-style: italic;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .stat-item {
        text-align: center;
      }
      .stat-val {
        font-size: 2rem;
        font-weight: 900;
      }
      .stat-lbl {
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: bold;
        color: #777;
      }

      /* --- Content Area --- */
      .game-board {
        background: white;
        border: var(--border);
        box-shadow: var(--shadow);
        min-height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .breadcrumbs {
        padding: 1rem;
        background: #eee;
        border-bottom: var(--border);
        font-size: 0.85rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }

      .crumb {
        color: #666;
      }
      .crumb:last-child {
        color: var(--accent);
        font-weight: bold;
      }
      .crumb::after {
        content: "→";
        margin-left: 0.5rem;
        color: #ccc;
      }
      .crumb:last-child::after {
        display: none;
      }

      .wiki-content {
        padding: 2rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        font-size: 1.1rem;
        overflow-x: hidden;
      }

      /* Wikipedia Specific Overrides to make it readable/playable */
      .wiki-content h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
      }
      .wiki-content h2 {
        font-size: 1.5rem;
        margin-top: 2rem;
        margin-bottom: 1rem;
        font-weight: bold;
        border-bottom: 1px solid #eee;
      }
      .wiki-content p {
        margin-bottom: 1rem;
      }
      .wiki-content ul {
        padding-left: 2rem;
        margin-bottom: 1rem;
      }
      .wiki-content a {
        color: #2980b9;
        text-decoration: none;
        font-weight: 500;
      }
      .wiki-content a:hover {
        text-decoration: underline;
        background: #e8f4fc;
      }
      .wiki-content .mw-empty-elt {
        display: none;
      }
      /* Hide clutter */
      .wiki-content .infobox,
      .wiki-content .sidebar,
      .wiki-content .thumb,
      .wiki-content .reference,
      .wiki-content .hatnote,
      .wiki-content .ambox,
      .wiki-content .reflist,
      .wiki-content table {
        display: none !important;
      }

      /* --- Buttons --- */
      button {
        background: var(--text);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-family: inherit;
        font-weight: 900;
        font-size: 1rem;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s;
        text-transform: uppercase;
      }
      button:hover {
        background: white;
        color: var(--text);
        border: var(--border);
        transform: translate(-2px, -2px);
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
      }
      button.secondary {
        background: #ddd;
        color: var(--text);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* --- Modal --- */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal {
        background: white;
        padding: 3rem;
        max-width: 600px;
        width: 90%;
        border: var(--border);
        box-shadow: 10px 10px 0px rgba(255, 255, 255, 0.2);
        text-align: center;
      }
      .modal h2 {
        color: var(--accent);
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      .leaderboard-section {
        margin-top: 2rem;
        border-top: 2px solid #eee;
        padding-top: 2rem;
      }

      .lb-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        font-family: -apple-system, sans-serif;
      }
      .lb-row.header {
        font-weight: bold;
        text-transform: uppercase;
        color: #888;
        font-size: 0.8rem;
      }

      /* Utility */
      .hidden {
        display: none !important;
      }
      .loading-spinner {
        font-size: 1.5rem;
        color: #888;
        text-align: center;
        padding: 3rem;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      @media (max-width: 900px) {
        .game-layout {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: static;
          margin-bottom: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header id="menuScreen">
        <h1>Wiki Speed Run</h1>
        <p style="margin-bottom: 2rem; color: #666">
          Navigate from A to B using only internal links.
        </p>

        <div class="controls">
          <button id="startBtn">Start Game</button>
        </div>

        <div class="leaderboard-section">
          <h3>Your Personal Bests (Local)</h3>
          <div
            id="localStats"
            style="margin-top: 1rem; font-style: italic; color: #888"
          >
            No games played yet.
          </div>
        </div>

        <div class="leaderboard-section">
          <h3>Global Leaderboard</h3>
          <div id="leaderboardList" style="margin-top: 1rem">Loading...</div>
        </div>
      </header>

      <div id="gameScreen" class="game-layout hidden">
        <aside class="sidebar">
          <div class="target-box">
            <div class="target-label">Target Page</div>
            <div class="target-title" id="targetDisplay">?</div>
            <div class="target-desc" id="targetDesc">
              Loading description...
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-val" id="clickCount">0</div>
              <div class="stat-lbl">Clicks</div>
            </div>
            <div class="stat-item">
              <div class="stat-val" id="timerDisplay">0:00</div>
              <div class="stat-lbl">Time</div>
            </div>
          </div>

          <button class="secondary" id="giveUpBtn">Give Up</button>
        </aside>

        <main class="game-board">
          <div class="breadcrumbs" id="breadcrumbs"></div>
          <div class="wiki-content" id="wikiContent"></div>
        </main>
      </div>
    </div>

    <div class="modal-overlay" id="winModal">
      <div class="modal">
        <h2>VICTORY!</h2>
        <p>
          You reached <strong><span id="winTargetName"></span></strong>
        </p>

        <div class="stats-grid" style="margin: 2rem 0">
          <div class="stat-item">
            <div class="stat-val" id="winClicks">0</div>
            <div class="stat-lbl">Clicks</div>
          </div>
          <div class="stat-item">
            <div class="stat-val" id="winTime">0:00</div>
            <div class="stat-lbl">Time</div>
          </div>
        </div>

        <input
          type="text"
          id="playerName"
          placeholder="Enter Name for Leaderboard"
          style="
            padding: 1rem;
            border: var(--border);
            width: 100%;
            margin-bottom: 1rem;
            font-size: 1.1rem;
          "
        />
        <button id="submitScoreBtn">Submit Score</button>
        <button class="secondary" id="playAgainBtn" style="margin-top: 0.5rem">
          Play Again
        </button>
      </div>
    </div>

    <script>
      // --- CONFIGURATION ---
      // Replace this URL with your Google Apps Script Web App URL if you have one.
      // If left as is, the game works perfectly but global leaderboard submission will fail gracefully.
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxJLd1l2RWakcrO0Txnjo65Cp4Bqp2RKe84R7bAwESuTvDTeDrMxF4mNXveKBUc108G/exec";

      // --- DATA POOLS ---
      const startingPoints = [
        "Spoon",
        "Rubber_duck",
        "Door_handle",
        "Shoelace",
        "Toaster",
        "Paper_clip",
        "Toothbrush",
        "Bicycle",
        "Pizza",
        "Sock",
        "Umbrella",
        "Pencil",
        "Soap",
        "Banana",
        "Chair",
        "Candle",
        "Backpack",
        "Mirror",
        "Kite",
        "Sandwich",
      ];

      const targetTopics = [
        "Quantum_mechanics",
        "The_Great_Gatsby",
        "Photosynthesis",
        "French_Revolution",
        "Black_hole",
        "Renaissance",
        "DNA",
        "Roman_Empire",
        "Industrial_Revolution",
        "Theory_of_relativity",
        "Plate_tectonics",
        "Artificial_intelligence",
        "World_War_II",
        "Impressionism",
        "Democracy",
        "Evolution",
        "Periodic_table",
        "Symphony_No._9_(Beethoven)",
        "Moon_landing",
        "Internet",
      ];

      // --- STATE ---
      let gameState = {
        active: false,
        startPage: "",
        targetPage: "",
        currentPage: "",
        clicks: 0,
        startTime: 0,
        timerInterval: null,
        path: [],
      };

      // --- DOM ELEMENTS ---
      const els = {
        menu: document.getElementById("menuScreen"),
        game: document.getElementById("gameScreen"),
        content: document.getElementById("wikiContent"),
        breadcrumbs: document.getElementById("breadcrumbs"),
        targetDisplay: document.getElementById("targetDisplay"),
        targetDesc: document.getElementById("targetDesc"),
        clicks: document.getElementById("clickCount"),
        timer: document.getElementById("timerDisplay"),
        winModal: document.getElementById("winModal"),
        startBtn: document.getElementById("startBtn"),
        giveUpBtn: document.getElementById("giveUpBtn"),
        submitBtn: document.getElementById("submitScoreBtn"),
        playAgainBtn: document.getElementById("playAgainBtn"),
      };

      // --- API HELPERS ---

      // Fetch Wiki Content using MediaWiki API (CORS friendly)
      async function fetchWikiContent(title) {
        const endpoint = `https://en.wikipedia.org/w/api.php?action=parse&page=${title}&prop=text&format=json&origin=*&redirects=1`;
        try {
          const response = await fetch(endpoint);
          const data = await response.json();
          if (data.error) throw new Error(data.error.info);
          return {
            title: data.parse.title,
            html: data.parse.text["*"],
          };
        } catch (e) {
          console.error("Wiki Fetch Error", e);
          return null;
        }
      }

      // Fetch Summary for Target Description
      async function fetchWikiSummary(title) {
        const endpoint = `https://en.wikipedia.org/api/rest_v1/page/summary/${title}`;
        try {
          const response = await fetch(endpoint);
          return await response.json();
        } catch (e) {
          return { description: "Target Page" };
        }
      }

      // --- GAME LOGIC ---

      async function startGame() {
        // Reset State
        gameState.clicks = 0;
        gameState.path = [];
        gameState.active = true;

        // Pick Randoms
        gameState.startPage =
          startingPoints[Math.floor(Math.random() * startingPoints.length)];
        gameState.targetPage =
          targetTopics[Math.floor(Math.random() * targetTopics.length)];

        // UI Setup
        els.menu.classList.add("hidden");
        els.game.classList.remove("hidden");
        els.winModal.style.display = "none";
        els.clicks.textContent = "0";
        els.timer.textContent = "0:00";

        // Load Target Info
        els.targetDisplay.textContent = gameState.targetPage.replace(/_/g, " ");
        fetchWikiSummary(gameState.targetPage).then((data) => {
          els.targetDesc.textContent =
            data.description || "A Wikipedia Article";
        });

        // Start Timer
        gameState.startTime = Date.now();
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        gameState.timerInterval = setInterval(updateTimer, 1000);

        // Load First Page
        await loadPage(gameState.startPage);
      }

      async function loadPage(title) {
        els.content.innerHTML = `<div class="loading-spinner">Traveling to ${title.replace(
          /_/g,
          " "
        )}...</div>`;

        const data = await fetchWikiContent(title);

        if (!data) {
          els.content.innerHTML = `<div class="error">Failed to load page. <button onclick="loadPage('${title}')">Try Again</button></div>`;
          return;
        }

        // Update State
        gameState.currentPage = data.title; // Use canonical title from API
        gameState.path.push(data.title);

        // Update UI
        updateBreadcrumbs();
        els.content.innerHTML = data.html;
        window.scrollTo(0, 0);

        // Process Links
        processLinks();

        // Check Win Condition
        // We compare simplified strings to avoid casing/underscore mismatch issues
        const cleanCurrent = data.title.toLowerCase().trim();
        const cleanTarget = gameState.targetPage
          .replace(/_/g, " ")
          .toLowerCase()
          .trim();

        if (cleanCurrent === cleanTarget) {
          handleWin();
        }
      }

      function processLinks() {
        const links = els.content.querySelectorAll("a");
        links.forEach((link) => {
          const href = link.getAttribute("href");

          // Logic: Must be internal Wiki link, not file, not special page
          if (href && href.startsWith("/wiki/") && !href.includes(":")) {
            link.onclick = (e) => {
              e.preventDefault();
              if (!gameState.active) return;

              const nextTitle = href.split("/wiki/")[1];
              gameState.clicks++;
              els.clicks.textContent = gameState.clicks;
              loadPage(nextTitle);
            };
          } else {
            // Disable external links or files to keep user in "Game Mode"
            link.removeAttribute("href");
            link.style.color = "#999";
            link.style.cursor = "default";
            link.style.textDecoration = "none";
          }
        });
      }

      function updateBreadcrumbs() {
        // Show last 4 items only if path is long
        const showPath =
          gameState.path.length > 4
            ? ["...", ...gameState.path.slice(-4)]
            : gameState.path;

        els.breadcrumbs.innerHTML = showPath
          .map(
            (item) => `<span class="crumb">${item.replace(/_/g, " ")}</span>`
          )
          .join("");
      }

      function updateTimer() {
        const delta = Math.floor((Date.now() - gameState.startTime) / 1000);
        const mins = Math.floor(delta / 60);
        const secs = delta % 60;
        els.timer.textContent = `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      function handleWin() {
        gameState.active = false;
        clearInterval(gameState.timerInterval);

        const timeVal = els.timer.textContent;

        document.getElementById("winTargetName").textContent =
          gameState.targetPage.replace(/_/g, " ");
        document.getElementById("winClicks").textContent = gameState.clicks;
        document.getElementById("winTime").textContent = timeVal;

        els.winModal.style.display = "flex";

        // Save Local Score
        saveLocalScore(gameState.clicks, timeVal);
      }

      // --- LEADERBOARD & DATA ---

      function saveLocalScore(clicks, time) {
        const history = JSON.parse(
          localStorage.getItem("wikiSpeedRun_history") || "[]"
        );
        history.push({
          date: new Date().toLocaleDateString(),
          clicks: clicks,
          time: time,
          route: `${gameState.startPage} → ${gameState.targetPage}`,
        });
        localStorage.setItem("wikiSpeedRun_history", JSON.stringify(history));
        renderLocalStats();
      }

      function renderLocalStats() {
        const history = JSON.parse(
          localStorage.getItem("wikiSpeedRun_history") || "[]"
        );
        if (history.length === 0) return;

        const best = history.sort((a, b) => a.clicks - b.clicks)[0]; // Sort by clicks
        document.getElementById("localStats").innerHTML = `
          <strong>Best Run:</strong> ${best.clicks} clicks in ${best.time} <br>
          <small>(${best.route})</small>
        `;
      }

      async function submitGlobalScore() {
        const name = document.getElementById("playerName").value || "Anonymous";
        els.submitBtn.textContent = "Submitting...";
        els.submitBtn.disabled = true;

        try {
          const timeInSeconds = Math.floor(
            (Date.now() - gameState.startTime) / 1000
          );

          await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "addScore",
              playerName: name,
              clicks: gameState.clicks,
              time: timeInSeconds,
              route: `${gameState.startPage} → ${gameState.targetPage}`,
              timestamp: Date.now(),
            }),
          });

          alert("Score Submitted!");
        } catch (e) {
          console.error(e);
          alert("Could not reach leaderboard server. Score saved locally.");
        } finally {
          els.submitBtn.textContent = "Submitted";
        }
      }

      async function loadGlobalLeaderboard() {
        const list = document.getElementById("leaderboardList");
        if (
          APPS_SCRIPT_URL.includes("script.google.com") &&
          !APPS_SCRIPT_URL.includes("YOUR_URL")
        ) {
          try {
            const res = await fetch(`${APPS_SCRIPT_URL}?action=getScores`);
            const data = await res.json();

            // Sort by clicks then time
            const scores = data.records
              .sort((a, b) => {
                if (a.clicks !== b.clicks) return a.clicks - b.clicks;
                return a.time - b.time;
              })
              .slice(0, 5); // Top 5

            list.innerHTML = scores
              .map(
                (s, i) => `
              <div class="lb-row">
                <span>#${i + 1} ${s.playerName}</span>
                <span>${s.clicks} clicks (${Math.floor(s.time / 60)}:${(
                  s.time % 60
                )
                  .toString()
                  .padStart(2, "0")})</span>
              </div>
            `
              )
              .join("");
          } catch (e) {
            list.innerHTML = "<small>Leaderboard unavailable</small>";
          }
        } else {
          list.innerHTML = "<small>Leaderboard not configured.</small>";
        }
      }

      // --- EVENTS ---
      els.startBtn.addEventListener("click", startGame);

      els.giveUpBtn.addEventListener("click", () => {
        if (confirm("Are you sure you want to quit?")) {
          location.reload();
        }
      });

      els.playAgainBtn.addEventListener("click", () => {
        location.reload();
      });

      els.submitBtn.addEventListener("click", submitGlobalScore);

      // --- INIT ---
      renderLocalStats();
      loadGlobalLeaderboard();
    </script>
  </body>
</html>
