<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wikipedia Speed Run</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f8f5f0;
        color: #1a1a1a;
        padding: 2rem;
        line-height: 1.6;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      header {
        text-align: center;
        margin-bottom: 3rem;
      }
      h1 {
        font-size: 3rem;
        font-weight: 900;
        margin-bottom: 1rem;
      }
      .subtitle {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 2rem;
      }
      .game-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
        margin-top: 2rem;
      }
      .sidebar {
        background: white;
        border: 4px solid black;
        padding: 1.5rem;
        height: fit-content;
        position: sticky;
        top: 2rem;
      }
      .stat {
        margin-bottom: 1.5rem;
      }
      .stat-label {
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #999;
        margin-bottom: 0.3rem;
      }
      .stat-value {
        font-size: 1.8rem;
        font-weight: 900;
        word-wrap: break-word;
      }
      .target {
        background: #ff6b6b;
        color: white;
        padding: 1rem;
        text-align: center;
        font-weight: 900;
        font-size: 1.3rem;
        margin-bottom: 1.5rem;
        border-radius: 4px;
      }
      .content-area {
        background: white;
        border: 4px solid black;
        padding: 2rem;
        min-height: calc(100vh - 200px);
        overflow-y: auto;
      }
      .content-area h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
      }
      .content-area a {
        color: #0645ad;
        text-decoration: none;
      }
      .content-area a:hover {
        text-decoration: underline;
      }
      .controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
      }
      button {
        background: black;
        color: white;
        border: 4px solid black;
        padding: 1rem 2rem;
        font-weight: 900;
        font-size: 1rem;
        cursor: pointer;
        text-transform: uppercase;
        transition: all 0.3s;
      }
      button:hover:not(:disabled) {
        background: white;
        color: black;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      button.secondary {
        background: white;
        color: black;
      }
      button.secondary:hover {
        background: black;
        color: white;
      }
      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 4px solid black;
        padding: 3rem;
        text-align: center;
        z-index: 1000;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 90%;
      }
      .modal.show {
        display: block;
      }
      .modal h2 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: #ff6b6b;
      }
      .win-stats {
        display: flex;
        gap: 2rem;
        justify-content: center;
        margin: 2rem 0;
      }
      .win-stat {
        text-align: center;
      }
      .win-stat-value {
        font-size: 3rem;
        font-weight: 900;
        color: #ff6b6b;
      }
      .win-stat-label {
        font-size: 0.9rem;
        text-transform: uppercase;
        color: #999;
        font-weight: 700;
      }
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      .overlay.show {
        display: block;
      }
      .loading {
        text-align: center;
        padding: 3rem;
        font-size: 1.2rem;
        color: #999;
      }
      .leaderboard {
        background: white;
        border: 4px solid black;
        padding: 2rem;
        margin-bottom: 2rem;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }
      .leaderboard h2 {
        font-size: 1.8rem;
        font-weight: 900;
        margin-bottom: 1.5rem;
        text-align: center;
      }
      .leaderboard-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        justify-content: center;
      }
      .tab {
        background: white;
        color: black;
        border: 3px solid black;
        padding: 0.6rem 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }
      .tab.active {
        background: black;
        color: white;
      }
      .leaderboard-list {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }
      .leaderboard-item {
        display: grid;
        grid-template-columns: 40px 1fr auto;
        gap: 1rem;
        align-items: center;
        padding: 0.8rem;
        background: #f8f5f0;
        border-radius: 4px;
      }
      .rank {
        font-size: 1.5rem;
        font-weight: 900;
        color: #999;
      }
      .rank.gold {
        color: #ffd700;
      }
      .rank.silver {
        color: #c0c0c0;
      }
      .rank.bronze {
        color: #cd7f32;
      }
      .route-info {
        font-size: 0.9rem;
      }
      .route-title {
        font-weight: 700;
        margin-bottom: 0.2rem;
      }
      .route-path {
        color: #666;
        font-size: 0.85rem;
      }
      .player-info {
        color: #0645ad;
        font-size: 0.8rem;
        margin-top: 0.2rem;
      }
      .score {
        font-size: 1.2rem;
        font-weight: 900;
        text-align: right;
      }
      .no-records {
        text-align: center;
        color: #999;
        padding: 2rem;
        font-style: italic;
      }
      .name-input {
        width: 100%;
        padding: 0.8rem;
        font-size: 1.1rem;
        border: 3px solid black;
        margin-bottom: 1.5rem;
        font-family: inherit;
      }
      .name-input:focus {
        outline: none;
        border-color: #ff6b6b;
      }
      .error-message {
        background: #ffe6e6;
        border: 2px solid #ff6b6b;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        color: #cc0000;
        font-weight: 700;
      }
      .setup-instructions {
        background: #fff3cd;
        border: 2px solid #ffc107;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        text-align: left;
        font-size: 0.9rem;
      }
      .setup-instructions h3 {
        color: #856404;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
      }
      .setup-instructions ol {
        margin-left: 1.5rem;
        color: #856404;
        line-height: 1.8;
      }
      .setup-instructions li {
        margin-bottom: 0.5rem;
      }
      .setup-instructions code {
        background: #fff;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        display: inline-block;
        margin: 0.2rem 0;
      }
      .setup-instructions a {
        color: #0645ad;
        font-weight: 700;
      }
      @media (max-width: 968px) {
        .game-container {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: static;
        }
        h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Wikipedia Speed Run</h1>
        <p class="subtitle">
          Get from one article to another by clicking links only
        </p>
        <div class="leaderboard">
          <h2>Leaderboard</h2>
          <div class="leaderboard-tabs">
            <button class="tab active" data-tab="clicks">Fewest Clicks</button>
            <button class="tab" data-tab="time">Fastest Time</button>
          </div>
          <div class="leaderboard-list" id="leaderboardList">
            <div class="loading">Loading leaderboard...</div>
          </div>
        </div>
        <div class="controls">
          <button id="startBtn">Start New Game</button>
          <button id="giveUpBtn" class="secondary" style="display: none">
            Give Up
          </button>
        </div>
      </header>
      <div class="game-container" style="display: none" id="gameContainer">
        <div class="sidebar">
          <div class="target">
            Target: <span id="targetPage">Philosophy</span>
          </div>
          <div class="stat">
            <div class="stat-label">Clicks</div>
            <div class="stat-value" id="clicks">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Time</div>
            <div class="stat-value" id="timer">0:00</div>
          </div>
          <div class="stat">
            <div class="stat-label">Current Page</div>
            <div class="stat-value" id="currentPage" style="font-size: 1.1rem">
              -
            </div>
          </div>
        </div>
        <div class="content-area" id="contentArea">
          <div class="loading">Loading Wikipedia...</div>
        </div>
      </div>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="modal" id="winMessage">
      <h2>You Win!</h2>
      <div class="win-stats">
        <div class="win-stat">
          <div class="win-stat-value" id="finalClicks">0</div>
          <div class="win-stat-label">Clicks</div>
        </div>
        <div class="win-stat">
          <div class="win-stat-value" id="finalTime">0:00</div>
          <div class="win-stat-label">Time</div>
        </div>
      </div>
      <p style="margin: 1rem 0; color: #666">
        Route: <span id="finalRoute"></span>
      </p>
      <input
        type="text"
        class="name-input"
        id="nameInput"
        placeholder="Enter your name for the leaderboard"
        maxlength="30"
      />
      <button id="submitScoreBtn">Submit Score</button>
    </div>
    <script>
      // ‚ö†Ô∏è REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT WEB APP URL ‚ö†Ô∏è
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxJLd1l2RWakcrO0Txnjo65Cp4Bqp2RKe84R7bAwESuTvDTeDrMxF4mNXveKBUc108G/exec";

      // Large collection of starting points (everyday objects)
      const startingPoints = [
        "Rubber_duck",
        "Paperclip",
        "Balloon",
        "Toothbrush",
        "Umbrella",
        "Scissors",
        "Pencil",
        "Stapler",
        "Envelope",
        "Button",
        "Zipper",
        "Shoelace",
        "Rubber_band",
        "Paper_towel",
        "Cotton_swab",
        "Adhesive_tape",
        "Thumbtack",
        "Clothespin",
        "Bookmark",
        "Doorknob",
        "Light_switch",
        "Coat_hanger",
        "Soap",
        "Candle",
        "Match",
        "Salt_shaker",
        "Sponge",
        "Towel",
        "Pillow",
        "Blanket",
        "Fork",
        "Spoon",
        "Knife",
        "Plate",
        "Cup",
        "Bowl",
        "Napkin",
        "Straw",
        "Bottle_opener",
        "Can_opener",
        "Corkscrew",
        "Whisk",
        "Grater",
        "Colander",
        "Spatula",
        "Ladle",
        "Tongs",
        "Rolling_pin",
        "Measuring_cup",
        "Cutting_board",
        "Oven_mitt",
        "Apron",
        "Dish_towel",
        "Saucepan",
        "Frying_pan",
        "Teapot",
        "Coffee_mug",
        "Wine_glass",
        "Coaster",
        "Placemat",
        "Tablecloth",
        "Chandelier",
        "Mirror",
        "Picture_frame",
        "Vase",
        "Lampshade",
        "Curtain",
        "Rug",
        "Doormat",
        "Trash_can",
        "Broom",
        "Mop",
        "Bucket",
        "Dustpan",
        "Vacuum_cleaner",
        "Iron",
        "Ironing_board",
        "Clothes_hanger",
        "Hamper",
        "Laundry_basket",
        "Clothesline",
        "Sewing_needle",
        "Thread",
        "Button",
        "Pin_cushion",
        "Thimble",
        "Measuring_tape",
        "Ruler",
        "Protractor",
        "Compass_(drawing_tool)",
        "Eraser",
        "Sharpener",
        "Highlighter",
        "Marker_pen",
        "Crayon",
        "Chalk",
        "Blackboard",
        "Whiteboard",
        "Cork_board",
        "Pushpin",
        "Paper_clip",
        "Binder_clip",
        "Hole_punch",
        "Staple_remover",
        "Tape_dispenser",
        "Glue_stick",
        "Rubber_cement",
        "Correction_fluid",
        "Calculator",
        "Notebook",
        "Notepad",
        "Sticky_note",
        "File_folder",
        "Manila_folder",
        "Cardboard_box",
        "Bubble_wrap",
        "Packing_tape",
        "String",
        "Rope",
        "Chain",
        "Hook",
        "Screw",
        "Bolt",
        "Nut_(hardware)",
        "Washer_(hardware)",
        "Rivet",
        "Hinge",
        "Lock",
        "Key",
        "Padlock",
        "Combination_lock",
        "Doorbell",
        "Light_bulb",
        "Battery_(electricity)",
        "Extension_cord",
        "Power_strip",
        "Flashlight",
        "Lantern",
        "Candelabra",
        "Oil_lamp",
        "Incense",
        "Air_freshener",
        "Fan",
        "Heater",
        "Thermostat",
        "Smoke_detector",
        "Fire_extinguisher",
        "First_aid_kit",
        "Bandage",
        "Gauze",
        "Thermometer",
        "Tweezers",
        "Nail_clipper",
        "Hairbrush",
        "Comb",
        "Hair_dryer",
        "Curling_iron",
        "Shaving_razor",
        "Shaving_cream",
        "Dental_floss",
        "Mouthwash",
        "Cotton_ball",
        "Tissue_(paper)",
        "Toilet_paper",
        "Paper_towel",
        "Hand_soap",
        "Shampoo",
        "Conditioner",
        "Body_wash",
        "Lotion",
        "Deodorant",
        "Perfume",
        "Cologne",
        "Lipstick",
        "Mascara",
        "Eyeshadow",
        "Nail_polish",
        "Makeup_brush",
        "Compact_(cosmetics)",
        "Hand_mirror",
        "Wallet",
        "Purse",
        "Backpack",
        "Suitcase",
        "Duffel_bag",
        "Tote_bag",
        "Shopping_bag",
        "Lunch_box",
        "Water_bottle",
        "Thermos",
        "Ice_cube_tray",
        "Cutting_board",
        "Cheese_grater",
        "Vegetable_peeler",
        "Garlic_press",
        "Bottle_opener",
        "Pizza_cutter",
        "Egg_timer",
        "Kitchen_scale",
        "Meat_thermometer",
        "Oven_thermometer",
        "Timer",
        "Hourglass",
        "Clock",
        "Alarm_clock",
        "Watch",
        "Stopwatch",
        "Metronome",
        "Tuning_fork",
        "Whistle",
        "Bell",
        "Gong",
        "Chime",
        "Rattle",
        "Tambourine",
        "Kazoo",
        "Harmonica",
        "Recorder_(musical_instrument)",
        "Flute",
        "Piccolo",
        "Clarinet",
        "Oboe",
        "Bassoon",
        "Saxophone",
        "Trumpet",
        "Trombone",
        "French_horn",
        "Tuba",
        "Violin",
        "Viola",
        "Cello",
        "Double_bass",
        "Guitar",
        "Ukulele",
        "Banjo",
        "Mandolin",
        "Harp",
        "Piano",
        "Keyboard_(musical)",
        "Organ_(music)",
        "Accordion",
        "Drum",
        "Cymbal",
        "Xylophone",
        "Maracas",
        "Bongos",
        "Conga",
      ];

      // Large collection of target topics (science, history, complex concepts)
      const targetTopics = [
        "Byzantine_Empire",
        "Quantum_entanglement",
        "Feudalism",
        "Supernova",
        "Renaissance",
        "Black_hole",
        "French_Revolution",
        "Photosynthesis",
        "Industrial_Revolution",
        "Evolution",
        "Ancient_Egypt",
        "DNA",
        "Viking_Age",
        "Periodic_table",
        "Magna_Carta",
        "Gravity",
        "Roman_Republic",
        "Cellular_respiration",
        "World_War_I",
        "Plate_tectonics",
        "Ancient_Greece",
        "Photon",
        "Middle_Ages",
        "Nuclear_fission",
        "Maya_civilization",
        "Atom",
        "Baroque",
        "Asteroid",
        "Enlightenment_(spiritual)",
        "Prokaryote",
        "Tang_dynasty",
        "Ecosystem",
        "Age_of_Discovery",
        "Electromagnetic_radiation",
        "Inca_Empire",
        "Mitochondrion",
        "Mesopotamia",
        "Protein",
        "Ottoman_Empire",
        "Neutrino",
        "Crusades",
        "Enzyme",
        "Mongol_Empire",
        "Quark",
        "Baroque_music",
        "Mitosis",
        "Holy_Roman_Empire",
        "Nebula",
        "Aztec_Empire",
        "Lipid",
        "Cold_War",
        "Photosynthesis",
        "Spanish_Inquisition",
        "Thermodynamics",
        "Protestant_Reformation",
        "Quantum_mechanics",
        "Thirty_Years'_War",
        "Relativity",
        "Hundred_Years'_War",
        "String_theory",
        "American_Revolution",
        "Big_Bang",
        "Russian_Revolution",
        "Dark_matter",
        "French_Revolution",
        "Entropy",
        "Glorious_Revolution",
        "Antimatter",
        "Cuban_Missile_Crisis",
        "Electromagnetism",
        "Treaty_of_Versailles",
        "Higgs_boson",
        "Pearl_Harbor",
        "Nuclear_fusion",
        "Battle_of_Waterloo",
        "Cosmic_microwave_background",
        "D-Day",
        "Radioactivity",
        "Fall_of_Constantinople",
        "Redshift",
        "Siege_of_Vienna",
        "Diffraction",
        "Battle_of_Hastings",
        "Doppler_effect",
        "Normandy_landings",
        "Centrifugal_force",
        "Sack_of_Rome_(1527)",
        "Coriolis_force",
        "Battle_of_Stalingrad",
        "Bernoulli's_principle",
        "Siege_of_Constantinople_(1453)",
        "Pascal's_law",
        "Battle_of_Tours",
        "Archimedes'_principle",
        "Battle_of_Lepanto",
        "Hooke's_law",
        "Battle_of_Thermopylae",
        "Ohm's_law",
        "Battle_of_Marathon",
        "Faraday's_law",
        "Battle_of_Salamis",
        "Newton's_laws_of_motion",
        "Battle_of_Actium",
        "Kepler's_laws",
        "Punic_Wars",
        "Boyle's_law",
        "Peloponnesian_War",
        "Charles's_law",
        "Trojan_War",
        "Avogadro's_law",
        "Persian_Wars",
        "Ideal_gas_law",
        "War_of_the_Roses",
        "Wien's_law",
        "Opium_Wars",
        "Stefan‚ÄìBoltzmann_law",
        "Boxer_Rebellion",
        "Hubble's_law",
        "Taiping_Rebellion",
        "Planck's_law",
        "Sepoy_Mutiny",
        "Schr√∂dinger_equation",
        "French_and_Indian_War",
        "Heisenberg_uncertainty_principle",
        "Seven_Years'_War",
        "Pauli_exclusion_principle",
        "War_of_1812",
        "Fermi_paradox",
        "Mexican‚ÄìAmerican_War",
        "Drake_equation",
        "Spanish‚ÄìAmerican_War",
        "Anthropic_principle",
        "Philippine‚ÄìAmerican_War",
        "Copernican_principle",
        "Boer_Wars",
        "Mach's_principle",
        "Crimean_War",
        "Equivalence_principle",
        "Russo-Japanese_War",
        "Uncertainty_principle",
        "Italian_Wars",
        "Correspondence_principle",
        "Wars_of_the_Diadochi",
        "Complementarity_principle",
        "Gallic_Wars",
        "Superposition_principle",
        "Social_War_(91‚Äì88_BC)",
        "Le_Chatelier's_principle",
        "Servile_Wars",
        "Aufbau_principle",
        "Mithridatic_Wars",
        "Hund's_rule",
        "Jugurthine_War",
        "Octet_rule",
        "Cimbrian_War",
        "Markovnikov's_rule",
        "Samnite_Wars",
        "Zaitsev's_rule",
        "Latin_War",
        "Bredt's_rule",
        "First_Punic_War",
        "Baldwin's_rules",
        "Second_Punic_War",
        "Fajan's_rules",
        "Third_Punic_War",
        "Woodward‚ÄìHoffmann_rules",
        "First_Macedonian_War",
        "H√ºckel's_rule",
        "Second_Macedonian_War",
        "Cahn‚ÄìIngold‚ÄìPrelog_priority_rules",
        "Third_Macedonian_War",
        "VSEPR_theory",
        "Fourth_Macedonian_War",
        "Molecular_orbital_theory",
        "Syrian_Wars",
        "Valence_bond_theory",
        "War_of_the_Spanish_Succession",
        "Crystal_field_theory",
        "War_of_the_Austrian_Succession",
        "Ligand_field_theory",
        "Great_Northern_War",
        "Band_theory",
        "Thirty_Years'_War",
        "Collision_theory",
        "Eighty_Years'_War",
        "Transition_state_theory",
        "Hundred_Years'_War",
        "Marcus_theory",
        "Wars_of_the_Three_Kingdoms",
        "RRKM_theory",
        "English_Civil_War",
        "Lindemann_mechanism",
        "War_of_the_Grand_Alliance",
        "Michaelis‚ÄìMenten_kinetics",
        "Nine_Years'_War",
      ];

      function getRandomRoute() {
        const start =
          startingPoints[Math.floor(Math.random() * startingPoints.length)];
        const target =
          targetTopics[Math.floor(Math.random() * targetTopics.length)];
        return { start, target };
      }

      let clicks = 0;
      let startTime = null;
      let timerInterval = null;
      let targetPage = "";
      let startingPage = "";
      let currentPage = "";
      let gameActive = false;
      let currentTab = "clicks";
      let pathHistory = [];

      const clicksEl = document.getElementById("clicks");
      const timerEl = document.getElementById("timer");
      const currentPageEl = document.getElementById("currentPage");
      const targetPageEl = document.getElementById("targetPage");
      const contentArea = document.getElementById("contentArea");
      const gameContainer = document.getElementById("gameContainer");
      const startBtn = document.getElementById("startBtn");
      const giveUpBtn = document.getElementById("giveUpBtn");
      const winMessage = document.getElementById("winMessage");
      const overlay = document.getElementById("overlay");
      const submitScoreBtn = document.getElementById("submitScoreBtn");
      const nameInput = document.getElementById("nameInput");
      const leaderboardList = document.getElementById("leaderboardList");

      async function loadLeaderboard() {
        try {
          const response = await fetch(`${APPS_SCRIPT_URL}?action=getScores`);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data.records || [];
        } catch (error) {
          console.error("Error loading leaderboard:", error);
          throw error;
        }
      }

      async function addRecord(playerName, clicks, time, route) {
        try {
          const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              action: "addScore",
              playerName,
              clicks,
              time,
              route,
              timestamp: Date.now(),
            }),
          });

          // no-cors mode doesn't allow reading response, so we assume success
          return true;
        } catch (error) {
          console.error("Error saving record:", error);
          throw error;
        }
      }

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
      }

      function formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        if (diffDays === 0) return "Today";
        if (diffDays === 1) return "Yesterday";
        if (diffDays < 7) return `${diffDays} days ago`;
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      async function displayLeaderboard(sortBy = "clicks") {
        leaderboardList.innerHTML = '<div class="loading">Loading...</div>';

        try {
          const records = await loadLeaderboard();

          if (records.length === 0) {
            leaderboardList.innerHTML =
              '<div class="no-records">No records yet. Play a game to set the first record!</div>';
            return;
          }

          const sorted = [...records].sort((a, b) => {
            if (sortBy === "clicks") {
              if (a.clicks !== b.clicks) return a.clicks - b.clicks;
              return a.time - b.time;
            } else {
              if (a.time !== b.time) return a.time - b.time;
              return a.clicks - b.clicks;
            }
          });

          const top10 = sorted.slice(0, 10);

          leaderboardList.innerHTML = top10
            .map((record, index) => {
              const rankClass =
                index === 0
                  ? "gold"
                  : index === 1
                  ? "silver"
                  : index === 2
                  ? "bronze"
                  : "";

              const timeStr = formatTime(record.time);

              return `
            <div class="leaderboard-item">
              <div class="rank ${rankClass}">${index + 1}</div>
              <div class="route-info">
                <div class="route-title">${record.route}</div>
                <div class="route-path">${
                  record.clicks
                } clicks ‚Ä¢ ${timeStr}</div>
                <div class="player-info">${record.playerName} ‚Ä¢ ${formatDate(
                record.timestamp
              )}</div>
              </div>
              <div class="score">${
                sortBy === "clicks" ? record.clicks : timeStr
              }</div>
            </div>
          `;
            })
            .join("");
        } catch (error) {
          console.error("Leaderboard error:", error);

          if (APPS_SCRIPT_URL === "YOUR_APPS_SCRIPT_URL_HERE") {
            leaderboardList.innerHTML = `
              <div class="setup-instructions">
                <h3>üìã Setup Instructions</h3>
                <ol>
                  <li>Open your Google Sheet at: <a href="https://docs.google.com/spreadsheets/d/1vBb6M86A9KWjsZRREt014HRyw8idKiVZ6e6QHFOuRkM" target="_blank">Open Sheet</a></li>
                  <li>Click <strong>Extensions ‚Üí Apps Script</strong></li>
                  <li>Delete any existing code and paste the code below</li>
                  <li>Click <strong>Deploy ‚Üí New Deployment</strong></li>
                  <li>Choose type: <strong>Web app</strong></li>
                  <li>Set "Execute as": <strong>Me</strong></li>
                  <li>Set "Who has access": <strong>Anyone</strong></li>
                  <li>Click <strong>Deploy</strong> and copy the Web App URL</li>
                  <li>Paste the URL in this HTML file where it says <code>YOUR_APPS_SCRIPT_URL_HERE</code></li>
                </ol>
                <p style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #ffc107;">
                  <strong>Need the Apps Script code?</strong> See the code in the second artifact below!
                </p>
              </div>
            `;
          } else {
            leaderboardList.innerHTML = `
              <div class="error-message">
                ‚ö†Ô∏è Error loading leaderboard: ${error.message}
              </div>
              <div class="no-records">
                Make sure your Apps Script is deployed correctly and the URL is correct.
              </div>
            `;
          }
        }
      }

      async function loadWikipediaPage(title) {
        contentArea.innerHTML = '<div class="loading">Loading...</div>';
        try {
          const response = await fetch(
            `https://en.wikipedia.org/api/rest_v1/page/html/${encodeURIComponent(
              title
            )}`
          );

          if (!response.ok) {
            throw new Error("Failed to load page");
          }

          let html = await response.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          doc
            .querySelectorAll("style, script, .mw-editsection")
            .forEach((el) => el.remove());

          const content = doc.body.innerHTML;
          contentArea.innerHTML = content;

          contentArea.querySelectorAll("a[href]").forEach((link) => {
            const href = link.getAttribute("href");
            if (href && href.startsWith("./") && !href.includes(":")) {
              link.addEventListener("click", (e) => {
                e.preventDefault();
                if (!gameActive) return;

                const pageTitle = href.replace("./", "").split("#")[0];
                clicks++;
                clicksEl.textContent = clicks;

                currentPage = decodeURIComponent(pageTitle).replace(/_/g, " ");
                currentPageEl.textContent = currentPage;
                pathHistory.push(currentPage);

                if (
                  currentPage.toLowerCase().trim() ===
                  targetPage.toLowerCase().trim()
                ) {
                  endGame(true);
                } else {
                  loadWikipediaPage(pageTitle);
                }
              });
            } else {
              link.addEventListener("click", (e) => e.preventDefault());
            }
          });
        } catch (error) {
          contentArea.innerHTML =
            '<div class="loading">Error loading page. Please try again.</div>';
          console.error("Error loading Wikipedia:", error);
        }
      }

      function startGame() {
        clicks = 0;
        gameActive = true;
        pathHistory = [];

        const route = getRandomRoute();
        targetPage = route.target.replace(/_/g, " ");
        startingPage = route.start.replace(/_/g, " ");
        currentPage = startingPage;
        pathHistory.push(startingPage);

        clicksEl.textContent = clicks;
        targetPageEl.textContent = targetPage;
        currentPageEl.textContent = startingPage;

        gameContainer.style.display = "grid";
        startBtn.style.display = "none";
        giveUpBtn.style.display = "inline-block";

        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 100);

        loadWikipediaPage(route.start);
      }

      function updateTimer() {
        if (!startTime) return;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = formatTime(elapsed);
      }

      function endGame(won = false) {
        gameActive = false;
        clearInterval(timerInterval);

        if (won) {
          const time = Math.floor((Date.now() - startTime) / 1000);
          const timeStr = formatTime(time);

          document.getElementById("finalClicks").textContent = clicks;
          document.getElementById("finalTime").textContent = timeStr;
          document.getElementById(
            "finalRoute"
          ).textContent = `${startingPage} ‚Üí ${targetPage}`;

          window.gameData = {
            clicks,
            time,
            route: `${startingPage} ‚Üí ${targetPage}`,
          };

          nameInput.value = "";
          winMessage.classList.add("show");
          overlay.classList.add("show");
          nameInput.focus();
        } else {
          gameContainer.style.display = "none";
          startBtn.style.display = "inline-block";
          giveUpBtn.style.display = "none";
        }
      }

      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentTab = tab.dataset.tab;
          displayLeaderboard(currentTab);
        });
      });

      startBtn.addEventListener("click", startGame);
      giveUpBtn.addEventListener("click", () => endGame(false));

      submitScoreBtn.addEventListener("click", async () => {
        if (APPS_SCRIPT_URL === "YOUR_APPS_SCRIPT_URL_HERE") {
          alert(
            "Please set up Google Apps Script first! Check the setup instructions in the leaderboard."
          );
          return;
        }

        const playerName = nameInput.value.trim() || "Anonymous";

        submitScoreBtn.disabled = true;
        submitScoreBtn.textContent = "Submitting...";

        try {
          await addRecord(
            playerName,
            window.gameData.clicks,
            window.gameData.time,
            window.gameData.route
          );

          await new Promise((resolve) => setTimeout(resolve, 2000));

          winMessage.classList.remove("show");
          overlay.classList.remove("show");

          await displayLeaderboard(currentTab);

          startGame();
        } catch (error) {
          console.error("Error submitting score:", error);
          alert(
            "Failed to submit score. Please check the console for details."
          );
        } finally {
          submitScoreBtn.disabled = false;
          submitScoreBtn.textContent = "Submit Score";
        }
      });

      nameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !submitScoreBtn.disabled) {
          submitScoreBtn.click();
        }
      });

      displayLeaderboard();
    </script>
  </body>
</html>
